<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>MED Test UNPID ‚Ä¢ Quiz Hub</title>

  <style>
    /* RESET & VARS (Apple-glass style) */
    :root{
      --bg-body:#fbfbfd;
      --glass: rgba(255,255,255,0.68);
      --glass-border: rgba(255,255,255,0.50);
      --glass-shadow: 0 14px 40px rgba(0,0,0,0.06);

      --primary:#0071e3;
      --primary-2:#4facfe;
      --primary-grad: linear-gradient(135deg, var(--primary), var(--primary-2));

      --text-main:#1d1d1f;
      --text-sec:#86868b;

      --danger:#ff3b30;
      --success:#34c759;
      --radius-l: 28px;
      --radius-m: 18px;
      --radius-s: 12px;

      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    html,body{height:100%;min-height:100dvh;width:100%;margin:0;padding:0;font-family:var(--font);color:var(--text-main);overflow:hidden;background:var(--bg-body);overscroll-behavior:none;}

    /* Ambient background */
    .ambient-bg{
      position:absolute; inset:-50%; width:200%; height:200%;
      background:
        radial-gradient(circle at 50% 50%, rgba(0,113,227,0.08), transparent 40%),
        radial-gradient(circle at 20% 80%, rgba(52,199,89,0.07), transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(175,82,222,0.07), transparent 40%);
      animation: moveBg 20s infinite alternate ease-in-out;
      z-index:-1;
      pointer-events:none;
      filter:saturate(115%);
    }
    @keyframes moveBg{
      0%{transform:translate(0,0) scale(1)}
      100%{transform:translate(-5%,-5%) scale(1.05)}
    }

    /* Shell */
    .app-shell{
      display:flex;
      flex-direction:column;
      height:100%;
      max-width:1200px;
      margin:0 auto;
      position:relative;
    }

    /* Glass panels */
    .glass-panel{
      background:var(--glass);
      backdrop-filter:saturate(180%) blur(24px);
      -webkit-backdrop-filter:saturate(180%) blur(24px);
      border:1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }

    header{
      padding: calc(20px + env(safe-area-inset-top, 0px)) 24px 20px 24px;
      display:flex; align-items:center; justify-content:space-between;
      z-index:100;
    }
    .logo-area{display:flex; align-items:center; gap:12px;}
    .logo-icon{
      width:40px;height:40px;border-radius:12px;
      background: var(--primary-grad);
      color:white;font-weight:900;font-size:1.15rem;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 12px rgba(0,113,227,0.25);
    }
    .app-name{font-weight:800;font-size:1.08rem; letter-spacing:-0.02em;}
    .nav-actions{display:flex;gap:12px; align-items:center;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
      color: var(--text-sec);
      font-weight:800;
      font-size:0.82rem;
    }

    .btn-icon{
      width:40px;height:40px;border-radius:50%;
      border:none;
      background:rgba(0,0,0,0.04);
      color:var(--text-main);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:transform .2s var(--ease), background .2s var(--ease);
      user-select:none;
      font-size:1.05rem;
    }
    .btn-icon:hover{background:rgba(0,0,0,0.08);transform:scale(1.05)}
    .btn-icon:active{transform:scale(0.97)}

    /* Views */
    .view-container{flex:1; position:relative; overflow:hidden;}
    .view{
      position:absolute; inset:0;
      padding:20px 24px 110px 24px;
      overflow-y:auto; overflow-x:hidden;
      opacity:0; pointer-events:none;
      transform: translateY(18px) scale(0.985);
      transition: opacity .42s var(--ease), transform .42s var(--ease);
      display:flex; flex-direction:column; gap:24px;
    }
    .view.active{
      opacity:1; pointer-events:auto;
      transform: translateY(0) scale(1);
      z-index:10;
    }

    /* Titles */
    .section-header{margin-bottom:2px;}
    .h2-title{font-size:2rem;font-weight:800;margin:0;letter-spacing:-0.02em;}
    .h-sub{color:var(--text-sec);font-size:1rem;margin-top:6px;line-height:1.45;}

    /* Buttons */
    .btn-primary{
      width:100%;
      padding:16px;
      border-radius:999px;
      border:none;
      background: var(--text-main);
      color:white;
      font-size:1rem;
      font-weight:800;
      cursor:pointer;
      transition:transform .2s var(--ease), box-shadow .2s var(--ease), opacity .2s var(--ease);
      user-select:none;
    }
    .btn-primary.blue{background: var(--primary);}
    .btn-primary:hover{transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.14);}
    .btn-primary:active{transform: scale(0.985);}
    .btn-primary:disabled{opacity:.45; cursor:not-allowed; transform:none; box-shadow:none;}
    .btn-secondary{
      width:100%;
      padding:14px 16px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.55);
      color: var(--text-main);
      font-weight:800;
      cursor:pointer;
      transition:transform .2s var(--ease), background .2s var(--ease);
    }
    .btn-secondary:hover{transform: translateY(-1px); background: rgba(255,255,255,0.75);}

    /* Inputs */
    .input-group{margin-bottom:14px;}
    .input-label{
      display:block; font-size:.82rem; font-weight:800;
      color: var(--text-sec); margin:0 0 8px 4px;
    }
    .input-field{
      width:100%;
      padding:16px;
      border-radius: var(--radius-m);
      border:1px solid transparent;
      background:#f2f2f7;
      font-size:1rem;
      font-weight:650;
      font-family:inherit;
      transition:all .2s var(--ease);
    }
    .input-field:focus{
      background:white;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.14);
    }
    .inline-row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .inline-row .input-field{max-width:160px; text-align:center;}

    /* Course grid */
    .grid-courses{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap:20px;
    }
    .course-card{
      border-radius: var(--radius-l);
      padding:24px;
      cursor:pointer;
      transition: all .3s var(--ease);
      display:flex;
      flex-direction:column;
      height:220px;
      justify-content:space-between;
      overflow:hidden;
      position:relative;
    }
    .course-card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(circle at 30% 20%, rgba(0,113,227,0.10), transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(175,82,222,0.08), transparent 60%);
      pointer-events:none;
    }
    .course-card > *{position:relative;}
    .course-card:hover{transform: translateY(-6px); box-shadow: 0 18px 50px rgba(0,0,0,0.08);}
    .course-icon{font-size:3rem; margin-bottom:10px;}
    .course-info h3{margin:0; font-size:1.45rem; font-weight:850; letter-spacing:-0.02em;}
    .course-info p{margin:8px 0 0 0; color: var(--text-sec); font-size:.95rem; line-height:1.4;}
    .course-stats{display:flex; gap:10px; margin-top:auto; flex-wrap:wrap;}
    .badge{
      font-size:0.78rem; font-weight:850; padding:7px 12px; border-radius:999px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.06);
      color: var(--text-sec);
    }

    /* Course view */
    .top-bar{display:flex; align-items:center; gap:12px; margin-bottom:4px;}
    .back-btn{font-weight:800;color: var(--text-sec); cursor:pointer; display:flex; align-items:center; gap:6px; font-size:.95rem; user-select:none;}
    .back-btn:hover{color: var(--primary);}

    .stats-row{display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
    @media (max-width: 720px){
      .stats-row{grid-template-columns:1fr;}
    }
    .stat-card{
      padding:20px; border-radius: var(--radius-m);
      display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
      position:relative; overflow:hidden;
    }
    .stat-card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(circle at 30% 0%, rgba(0,113,227,0.10), transparent 55%);
      pointer-events:none;
    }
    .stat-card > *{position:relative;}
    .stat-val{font-size:2rem; font-weight:900;}
    .stat-label{font-size:.78rem; font-weight:900; color: var(--text-sec); text-transform:uppercase; letter-spacing:.06em;}
    .stat-mini{margin-top:10px; color: var(--text-sec); font-weight:750; font-size:.92rem; line-height:1.35;}

    .panel{
      padding:24px;
      border-radius: var(--radius-l);
    }

    /* Module grid */
    .modules-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap:12px;
      margin-top:14px;
    }
    .module-item{
      padding:16px;
      border-radius: var(--radius-m);
      border:2px solid transparent;
      background: rgba(255,255,255,0.75);
      cursor:pointer;
      transition: all .2s var(--ease);
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      user-select:none;
    }
    .module-item:hover{transform: translateY(-2px);}
    .module-item.selected{
      border-color: var(--primary);
      background: rgba(0,113,227,0.06);
    }
    .m-title{font-weight:850;font-size:.98rem;margin-bottom:6px;}
    .m-sub{font-size:.82rem;color: var(--text-sec);}

    /* Segmented controls */
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      background: rgba(0,0,0,0.05);
      color: var(--text-sec);
      font-weight:850;
      cursor:pointer;
      transition: all .2s var(--ease);
      user-select:none;
    }
    .seg button:hover{background: rgba(0,0,0,0.08);}
    .seg button.active{
      background: rgba(0,113,227,0.12);
      color: var(--primary);
    }

    /* Charts */
    .chart-wrap{
      margin-top:14px;
      border-radius: var(--radius-l);
      padding:14px;
      background: rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
    }
    canvas{width:100%; display:block;}
    .module-list{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      max-height:220px;
      overflow:auto;
      padding-right:2px;
    }
    @media (max-width: 720px){
      .module-list{grid-template-columns:1fr;}
    }
    .module-row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius: var(--radius-m);
      background: rgba(255,255,255,0.70);
      border:1px solid rgba(0,0,0,0.06);
      font-weight:850;
      color: var(--text-main);
    }
    .module-row .val{color: var(--primary);}

    /* Quiz view */
    .quiz-progress{height:6px;background: rgba(0,0,0,0.06); border-radius:999px; overflow:hidden; margin:8px 0 18px 0;}
    .quiz-bar{height:100%; background: var(--primary); width:0%; transition: width .35s ease;}

    .question-card{
      padding:32px 24px;
      text-align:center;
      border-radius: var(--radius-l);
      min-height:200px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:18px;
    }
    .q-text{font-size:1.35rem;font-weight:850;line-height:1.4;}
    .q-chip{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(0,113,227,0.10);
      border:1px solid rgba(0,113,227,0.12);
      color: var(--primary);
      font-weight:900;
      font-size:.82rem;
    }

    .options-stack{display:flex; flex-direction:column; gap:12px; padding-bottom:24px;}
    .opt-btn{
      width:100%;
      padding:20px 24px;
      text-align:left;
      border-radius: var(--radius-m);
      border:1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.85);
      font-size:1rem;
      font-weight:750;
      cursor:pointer;
      transition: all .2s var(--ease);
      box-shadow: 0 6px 16px rgba(0,0,0,0.03);
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .opt-btn:active{transform: scale(0.985);}
    .opt-btn.correct{background: #e8fce8; border-color: rgba(52,199,89,0.55); color:#0b5a22;}
    .opt-btn.wrong{background:#ffebeb; border-color: rgba(255,59,48,0.55); color:#8a1111;}
    .opt-btn:disabled{cursor:default; opacity:1;}

    /* Floating bars */
    .float-bar{
      position:fixed;
      bottom: calc(24px + env(safe-area-inset-bottom));
      left:50%;
      transform: translateX(-50%);
      width: min(92%, 640px);
      padding:10px;
      border-radius:999px;
      display:flex;
      gap:10px;
      z-index:150;
      opacity:0;
      pointer-events:none;
      transition: all .3s var(--ease);
    }
    .float-bar.visible{opacity:1; pointer-events:auto; bottom: calc(32px + env(safe-area-inset-bottom));}
    .float-mini{
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.65);
      color: var(--text-sec);
      font-weight:850;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .float-mini strong{color: var(--text-main);}
    .float-btn{
      flex:1;
      padding:14px 16px;
      border-radius:999px;
      border:none;
      background: var(--primary);
      color:white;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 14px 34px rgba(0,113,227,0.25);
      transition: transform .2s var(--ease), opacity .2s var(--ease);
    }
    .float-btn:active{transform: scale(0.985);}
    .float-btn:disabled{opacity:.45; cursor:not-allowed; transform:none;}
    .float-btn.secondary{
      background: rgba(0,0,0,0.06);
      color: var(--text-main);
      box-shadow:none;
    }

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.36);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index:200;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal-overlay.active{display:flex; animation: fadeIn .18s ease;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{
      width:min(520px, 100%);
      border-radius: 28px;
      padding: 22px;
      position:relative;
    }
    .modal h3{margin:0 0 6px 0; font-weight:900;}
    .modal p{margin:0 0 14px 0; color: var(--text-sec); line-height:1.45;}
    .modal .x{
      position:absolute; top:14px; right:14px;
      width:40px;height:40px;border-radius:50%;
      border:none;background: rgba(0,0,0,0.05);
      cursor:pointer;
    }
    .error{
      margin-top:10px;
      padding:12px 14px;
      border-radius: var(--radius-m);
      background: rgba(255,59,48,0.10);
      border: 1px solid rgba(255,59,48,0.20);
      color: #8a1111;
      font-weight:800;
      display:none;
    }

    /* Small helpers */
    .hidden{display:none !important;}
    .pill-link{
      border:none;
      background:transparent;
      color: var(--primary);
      font-weight:850;
      cursor:pointer;
      padding:0;
    }
    .divider{height:1px; background: rgba(0,0,0,0.06); margin:16px 0;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  
    /* Toasts */
    .toast-stack{
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
      width: min(92vw, 460px);
    }
    .toast{
      pointer-events: auto;
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,0.68);
      border: 1px solid rgba(255,255,255,0.70);
      box-shadow: 0 16px 46px rgba(0,0,0,0.12);
      -webkit-backdrop-filter: blur(18px);
      backdrop-filter: blur(18px);
      overflow: hidden;
      position: relative;
    }
    .toast::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 3px;
      background: rgba(0,113,227,0.95);
    }
    .toast.success::before{ background: rgba(52,199,89,0.95); }
    .toast.warn::before{ background: rgba(255,159,10,0.95); }
    .toast.danger::before{ background: rgba(255,59,48,0.95); }
    .toast h4{ margin:0; font-size: 13px; letter-spacing: .2px; }
    .toast p{ margin:3px 0 0; color: var(--text-sec); font-size: 12.5px; line-height: 1.35; }
    .toast .t-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .toast .t-btn{
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 750;
      font-size: 12px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.65);
      cursor: pointer;
    }
    .toast .t-btn.primary{
      background: rgba(0,113,227,0.92);
      border-color: rgba(0,113,227,0.55);
      color: #fff;
    }
    .toast .t-x{
      margin-left:auto;
      border:none;
      background:transparent;
      cursor:pointer;
      opacity:.6;
      font-size: 16px;
      line-height: 1;
      padding: 2px 6px;
    }
    .toast .t-x:hover{ opacity: 1; }

    /* Auth success panel */
    .notice{
      padding: 14px;
      border-radius: 18px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.65);
      box-shadow: 0 16px 46px rgba(0,0,0,0.06);
    }
    .notice-title{ margin:0; font-size: 15px; font-weight: 850; }
    .notice-sub{ margin:6px 0 0; color: var(--text-sec); font-size: 13px; line-height: 1.35; }

  
    .search-card.selected{
      outline: 2px solid rgba(0,113,227,0.55);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.12);
    }
</style>
</head>

<body>
  <div class="ambient-bg"></div>

  <div class="app-shell">
    <header>
      <div class="logo-area">
        <div class="logo-icon">M</div>
        <div>
          <div class="app-name">MED Test UNPID</div>
          <div style="color:var(--text-sec);font-weight:750;font-size:.9rem;margin-top:2px;" id="crumb">Corsi</div>
        </div>
      </div>

      <div class="nav-actions">
        <button class="btn-icon" title="Home" aria-label="Home" onclick="goHome()">‚åÇ</button>
      </div>
    </header>

    <div class="view-container">
      <!-- DASHBOARD -->
      <section id="view-dashboard" class="view active">
        <div class="section-header">
          <h2 class="h2-title">Corsi disponibili</h2>
          <p class="h-sub">Scegli un corso. Statistiche, errori e ripasso si sbloccano col login.</p>
        </div>

        <div class="glass-panel panel" style="margin-bottom:18px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900;">Account</h3>
              <p class="h-sub" style="margin-top:6px;" id="user-display-dash">Ospite (login opzionale)</p>
            </div>
            <span class="chip" id="chip-auth">üîí Ospite</span>
          </div>

          <div id="dash-loggedout">
            <div style="height:10px"></div>
            <div class="inline-row">
              <button class="btn-primary blue" style="max-width:220px;" onclick="openAuth('login')">Accedi</button>
              <button class="btn-secondary" style="max-width:220px;" onclick="openAuth('signup')">Registrati</button>
            </div>
            <p class="h-sub" style="margin-top:12px;">Con il login sblocchi grafici, errori e ripasso (separati per corso).</p>
          </div>

          <div id="dash-loggedin" class="hidden">
            <div style="height:10px"></div>
            <div class="inline-row">
              <button class="btn-secondary" style="max-width:220px;" onclick="openAuth('login')">Gestisci account</button>
              <button class="btn-secondary" style="max-width:220px;" onclick="switchAccount()">Cambia account</button>
              <button class="btn-secondary" style="max-width:220px; border-color: rgba(255,59,48,0.35);" onclick="logout()">Esci</button>
            </div>
          </div>
        </div>
        <div class="grid-courses" id="courses-grid"></div>
      </section>


      <!-- AUTH -->
      <section id="view-auth" class="view">
        <div class="top-bar">
          <div class="back-btn" onclick="navBackFromAuth()">‚Üê Indietro</div>
        </div>

        <div class="section-header">
          <h2 class="h2-title">Account</h2>
          <p class="h-sub">Login email + password per salvare statistiche, errori e ripasso.</p>
        </div>

        <div class="glass-panel panel">
          <h3 id="auth-title" style="margin:0;">Accedi</h3>
          <p id="auth-sub" class="h-sub" style="margin-top:8px;">Email + password. Statistiche separate per corso.</p>

          <div class="divider"></div>

          <p id="user-display" style="margin:0; font-weight:850;">Ospite</p>
          <div style="height:10px"></div>

          <div class="error" id="auth-error"></div>

          <!-- In-app feedback (no browser alert) -->
          <div id="auth-success" class="notice hidden" style="margin-top:12px;">
            <p class="notice-title" id="auth-success-title">Operazione completata</p>
            <p class="notice-sub" id="auth-success-sub">‚Äî</p>
            <div class="divider" style="margin:12px 0;"></div>
            <div class="inline-row" style="flex-wrap:wrap;">
              <button class="btn-primary blue" id="auth-success-primary" onclick="authSuccessPrimary()">Vai ai corsi</button>
              <button class="btn-secondary" id="auth-success-secondary" onclick="authSuccessSecondary()">Accedi</button>
            </div>
          </div>


          <!-- When logged out -->
          <div id="profile-loggedout">
            <div id="auth-login">
              <div class="input-group">
                <label class="input-label">Email</label>
                <input class="input-field" id="loginEmail" type="email" autocomplete="email" placeholder="nome@scuola.it" />
              </div>
              <div class="input-group">
                <label class="input-label">Password</label>
                <input class="input-field" id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
              <button type="button" class="btn-primary blue" id="btn-login" onclick="login()">Accedi</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary hidden" id="btn-resend" onclick="resendSignupEmail()">Reinvia email di conferma</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary" onclick="openAuth('signup')">Non hai un account? Registrati</button>
            </div>

            <div id="auth-signup" class="hidden">
              <div class="input-group">
                <label class="input-label">Username</label>
                <input class="input-field" id="signupUser" type="text" autocomplete="nickname" placeholder="Es: Ludovico" />
              </div>
              <div class="input-group">
                <label class="input-label">Email</label>
                <input class="input-field" id="signupEmail" type="email" autocomplete="email" placeholder="nome@scuola.it" />
              </div>
              <div class="input-group">
                <label class="input-label">Password (min 8)</label>
                <input class="input-field" id="signupPass" type="password" autocomplete="new-password" placeholder="Min 8 caratteri" />
              </div>
              <button type="button" class="btn-primary blue" id="btn-signup" onclick="signup()">Crea account</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary hidden" id="btn-resend-signup" onclick="resendSignupEmail(true)">Reinvia email di conferma</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary" onclick="openAuth('login')">Hai gi√† un account? Accedi</button>
            </div>

            <p class="h-sub" style="margin-top:14px;">
              Tip: in sviluppo puoi disattivare ‚ÄúConfirm email‚Äù su Supabase Auth.
            </p>
          </div>

          <!-- When logged in -->
          <div id="profile-loggedin" class="hidden">
            <p class="h-sub">Sei loggato. Le statistiche vengono salvate automaticamente.</p>
            <div style="height:12px"></div>
            <div class="inline-row">
              <button class="btn-primary" style="max-width:240px;" onclick="navTo('dashboard')">Vai ai corsi</button>
              <button class="btn-secondary" style="max-width:240px;" onclick="switchAccount()">Cambia account</button>
              <button class="btn-secondary" style="max-width:200px; border-color: rgba(255,59,48,0.35);" onclick="logout()">Esci</button>
            </div>
          </div>
        </div>
      </section>

      <!-- COURSE -->
      <section id="view-course" class="view">
        <div class="top-bar">
          <div class="back-btn" onclick="navTo('dashboard')">‚Üê Corsi</div>
        </div>

        <div class="section-header">
          <h2 class="h2-title" id="course-title">Corso</h2>
          <p class="h-sub" id="course-desc">‚Äî</p>
        </div>

        <div class="stats-row">
          <div class="glass-panel stat-card">
            <div class="stat-val" id="stat-avg">‚Äî%</div>
            <div class="stat-label">Media corso</div>
            <div class="stat-mini" id="stat-avg-sub">Accedi per vedere la tua media in questo corso.</div>
          </div>
          <div class="glass-panel stat-card">
            <div class="stat-val" id="stat-done">‚Äî</div>
            <div class="stat-label">Quiz svolti</div>
            <div class="stat-mini" id="stat-done-sub">Accedi per vedere la cronologia dei quiz.</div>
          </div>
        </div>

        <!-- Progress chart -->
        <div class="glass-panel panel" id="panel-progress">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:14px; flex-wrap:wrap;">
            <h3 style="margin:0; font-weight:900;">Andamento</h3>
            <div class="seg">
              <button id="btn-line" class="active" onclick="setProgressType('line')">Linea</button>
              <button id="btn-bar" onclick="setProgressType('bar')">Istogramma</button>
            </div>
          </div>
          <p class="h-sub" style="margin-top:8px;">Ultimi 30 quiz in questo corso.</p>
          <div class="chart-wrap">
            <canvas id="progressChart" height="130"></canvas>
          </div>
          <div class="divider"></div>
          <div class="inline-row">
            <button class="btn-secondary" style="max-width:220px;" id="btn-wrong" onclick="openQuizSettings('wrong')">‚ö†Ô∏è Quiz errori</button>
            <button class="btn-secondary" style="max-width:240px;" id="btn-old" onclick="openQuizSettings('old')">üï∞Ô∏è Ripasso vecchie</button>
            <div style="color:var(--text-sec);font-weight:800;">
              Errori: <strong id="wrong-count">‚Äî</strong> ‚Ä¢ Vecchia: <strong id="oldest-label">‚Äî</strong>
            </div>
          </div>
          <div class="error" id="locked-hint">
            Questa sezione richiede login (email+password).
            <div style="height:10px"></div>
            <button class="btn-primary blue" style="max-width:220px;" onclick="openAuth('login')">Accedi</button>
          </div>
        </div>

        <!-- Module accuracy -->
        <div class="glass-panel panel hidden" id="panel-modules">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:14px; flex-wrap:wrap;">
            <h3 style="margin:0; font-weight:900;">Accuratezza per modulo</h3>
            <span class="chip">calcolata da <span class="mono">question_progress</span></span>
          </div>
          <div class="chart-wrap">
            <canvas id="moduleChart" height="180"></canvas>
          </div>
          <div class="module-list" id="moduleList"></div>
        </div>

        <!-- Search -->
        <div class="glass-panel panel">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900;">Ricerca nel corso</h3>
              <p class="h-sub">Cerca parole chiave e costruisci un quiz dai risultati.</p>
            </div>
            <button class="btn-secondary" style="max-width:160px;" id="btn-search-start" onclick="openQuizSettings('search')" disabled>Avvia</button>
          </div>
          <div style="height:10px"></div>
          <input class="input-field" id="search" placeholder="Es: talamo, cornea, Murphy..." oninput="onSearch()" />
          <div style="margin-top:14px; display:flex; flex-direction:column; gap:12px; max-height:260px; overflow:auto;" id="searchResults"></div>
        </div>

        <!-- Modules selection -->
        <div class="glass-panel panel">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900;">Moduli</h3>
              <p class="h-sub">Seleziona i moduli, poi scegli quante domande quando avvii il quiz.</p>
            </div>
            <button class="pill-link" onclick="selectAllModules()">Seleziona tutti</button>
          </div>

          <div class="modules-grid" id="modules-list"></div>
          <div style="height:12px"></div>

          <div class="inline-row">
            <button class="btn-secondary" style="max-width:220px;" onclick="clearModules()">Deseleziona</button>
            <button class="btn-secondary" style="max-width:260px;" onclick="openQuizSettings('course_exam')">üéì Simulazione corso</button>
          </div>
        </div>

        <div style="height:80px;"></div>
      </section>

      <!-- QUIZ -->
      <section id="view-quiz" class="view">
        <div class="top-bar" style="justify-content:space-between;">
          <div class="back-btn" onclick="quitQuiz()">‚úï Esci</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="q-chip" id="q-chip">‚Äî</span>
            <div style="font-weight:800; color:var(--text-sec);" id="q-counter">1 / 10</div>
          </div>
        </div>

        <div class="quiz-progress">
          <div class="quiz-bar" id="progress-bar"></div>
        </div>

        <div class="glass-panel question-card">
          <div class="q-text" id="q-text">Caricamento domanda...</div>
        </div>

        <div class="options-stack" id="options-container"></div>

        <div class="quiz-footer" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
          <button class="btn-secondary" id="btn-skip" style="flex:1; min-width:160px;" onclick="skipQuestion()">Salta</button>
          <button class="btn-primary blue" id="btn-next" style="flex:1; min-width:180px;" onclick="nextQuestion()" disabled>Prossima ‚Üí</button>
        </div>
      </section>

      <!-- RESULTS -->
      <section id="view-results" class="view" style="text-align:center; justify-content:center;">
        <div class="glass-panel" style="padding:40px; border-radius:32px; display:inline-flex; flex-direction:column; align-items:center; max-width:420px; margin:0 auto;">
          <div style="width:120px; height:120px; border-radius:50%; background:#f5f5f7; display:flex; align-items:center; justify-content:center; margin-bottom:20px; box-shadow:inset 0 4px 12px rgba(0,0,0,0.05);">
            <div style="font-size:2.5rem; font-weight:900; color:var(--primary);" id="final-score">80%</div>
          </div>
          <h2 class="h2-title" style="margin:0;">Sessione completata</h2>
          <p class="h-sub" id="final-msg" style="margin:10px 0 26px 0;">Ottimo lavoro.</p>

          <div style="display:flex; gap:10px; width:100%; flex-wrap:wrap;">
            <button class="btn-primary blue" style="flex:1; min-width:180px;" onclick="backToCourse()">Torna al corso</button>
            <button class="btn-secondary" style="flex:1; min-width:180px;" onclick="navTo('dashboard')">Corsi</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Floating: Start button in course -->
    <div class="glass-panel float-bar" id="course-actions">
      <div class="float-mini">Selezionati: <strong id="sel-count">0</strong></div>
      <button class="float-btn" id="btn-start" disabled onclick="openQuizSettings('modules')">Avvia Quiz</button>
      <button class="float-btn secondary" onclick="navTo('dashboard')">Chiudi</button>
    </div>

  </div>

  <!-- Quiz settings modal -->
  <div class="modal-overlay" id="settings-modal" onclick="if(event.target===this) closeSettings()">
    <div class="glass-panel modal" role="dialog" aria-modal="true">
      <button class="x" aria-label="Chiudi" onclick="closeSettings()">‚úï</button>
      <h3>Impostazioni quiz</h3>
      <p id="settings-desc">Scegli quante domande vuoi fare.</p>

      <div class="input-group">
        <label class="input-label">Numero domande (0 = tutte)</label>
        <div class="inline-row">
          <input class="input-field" id="settings-limit" type="number" min="0" value="20" />
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(10)">10</button>
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(20)">20</button>
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(0)">Tutte</button>
        </div>
      </div>

      <div class="divider"></div>

      <div id="settings-old-wrap" class="hidden">
        <div class="input-group">
          <label class="input-label">Ripasso: domande non viste da almeno (giorni)</label>
          <div class="inline-row">
            <input class="input-field" id="settings-old-days" type="number" min="0" value="14" />
            <button class="btn-secondary" style="max-width:160px;" onclick="setOldDays(3)">3</button>
            <button class="btn-secondary" style="max-width:160px;" onclick="setOldDays(7)">7</button>
            <button class="btn-secondary" style="max-width:160px;" onclick="setOldDays(14)">14</button>
          </div>
          <label style="display:flex; gap:10px; align-items:center; margin-top:10px; font-weight:750; color:var(--text-sec);">
            <input type="checkbox" id="settings-old-unseen" checked />
            Include anche le domande mai viste
          </label>
        </div>
        <div class="divider"></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn-secondary" style="flex:1; min-width:180px;" onclick="closeSettings()">Annulla</button>
        <button class="btn-primary blue" style="flex:1; min-width:180px;" id="settings-start" onclick="startFromSettings()">Avvia</button>
      </div>
      <div class="error" id="settings-error"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./neuro_questions.js"></script>
  <script>
    /***********************************************************************
     * SUPABASE CONFIG
     * - Inserisci le tue credenziali
     **********************************************************************/
    const SUPABASE_URL = "https://haohnwguytakaqqqmflj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhhb2hud2d1eXRha2FxcXFtZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzU0NDUsImV4cCI6MjA4MjQxMTQ0NX0.bsy2ClUJLoFv7hX5ypnzVAXtUzUTUnkX5sVpSWUTjaw";

    // fetch wrapper con timeout (evita il blocco infinito su "Accesso..." se la richiesta resta appesa)
    function fetchWithTimeout(ms=15000){
      return (url, options={}) => {
        const controller = new AbortController();
        const id = setTimeout(()=>controller.abort(), ms);
        const opts = { ...options, signal: controller.signal };
        return fetch(url, opts).finally(()=> clearTimeout(id));
      };
    }

    const supa = (SUPABASE_URL.includes("YOUR_PROJECT") || SUPABASE_ANON_KEY.includes("YOUR_ANON"))
      ? null
      : supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        global: { fetch: fetchWithTimeout(15000) },
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true,
          flowType: "pkce"
        }
      });

    /***********************************************************************
     * QUIZ PACKS (MODULARI)
     * - Aggiungi corsi qui.
     * - Formato domanda: { q:"...", a:["corretta","errata","errata","errata"], cat?:"..." }
     **********************************************************************/
    const QUIZ_PACKS = {
      neuro: {
        id: "neuro",
        title: "Neuroanatomia",
        desc: "Tronco encefalico, midollo, vie e concetti base.",
        icon: "üß†",
        modules: window.NEURO_MODULES || {}
      },

      semeiotica: {
        id: "semeiotica",
        title: "Semeiotica",
        desc: "Addome e torace: segni clinici fondamentali.",
        icon: "ü©∫",
        modules: {
          "Addome": [
            { q: "Il segno di Murphy √® positivo quando:", a: ["Dolore e arresto inspiratorio alla palpazione ipocondrio dx", "Dolore alla fossa iliaca dx", "Ittero improvviso", "Vomito incoercibile"], cat:"Addome" },
            { q: "La peritonite d√† tipicamente:", a: ["Addome 'a tavola' e dolorabilit√† diffusa", "Murmullo vescicolare ridotto", "Edema declive", "Cianosi"], cat:"Addome" },
            { q: "La manovra di Blumberg valuta:", a: ["Dolore da rimbalzo per irritazione peritoneale", "Fremito vocale tattile", "Riflesso corneale", "Polso paradosso"], cat:"Addome" },
            { q: "La splenomegalia si ricerca meglio:", a: ["Con palpazione bimanuale in inspirazione profonda", "Con percussione toracica", "Con test di Romberg", "Con manovra di Las√®gue"], cat:"Addome" },
            { q: "L'ascite si conferma con:", a: ["Segno dell'onda e ottusit√† mobile", "Segno di Babinski", "Segno di Kernig", "Segno di Homan"], cat:"Addome" }
          ],
          "Torace": [
            { q: "Il fremito vocale tattile diminuisce in:", a: ["Versamento pleurico", "Consolidamento polmonare", "Fibrosi iniziale", "Asma lieve"], cat:"Torace" },
            { q: "La crepitazione fine bibasale pu√≤ indicare:", a: ["Edema polmonare", "Appendicite", "Otite", "Emicrania"], cat:"Torace" },
            { q: "In pneumotorace iperteso tipicamente trovi:", a: ["Ipotensione + trachea deviata controlateralmente", "Bradicardia e polso pieno", "Ittero", "Rigor nucale"], cat:"Torace" },
            { q: "La percussione iperfonica suggerisce:", a: ["Pneumotorace o enfisema", "Consolidamento", "Versamento", "Atelettasia completa"], cat:"Torace" },
            { q: "Il murmurio vescicolare √®:", a: ["Rumore respiratorio fisiologico", "Soffio cardiaco", "Rumore intestinale", "Tono muscolare"], cat:"Torace" }
          ]
        }
      },

      dermato: {
        id: "dermato",
        title: "Dermatologia",
        desc: "Lesioni elementari e diagnosi rapide.",
        icon: "üß¥",
        modules: {
          "Lesioni elementari": [
            { q: "Una macula √®:", a: ["Lesione piana con variazione di colore", "Lesione rilevata con pus", "Nodulo profondo", "Ulcerazione"], cat:"Base" },
            { q: "Una papula √®:", a: ["Lesione rilevata solida < 1 cm", "Lesione piana pigmentata", "Vescicola piena di liquido", "Placca estesa > 10 cm"], cat:"Base" },
            { q: "Una vescicola contiene:", a: ["Liquido chiaro", "Pus", "Sangue sempre", "Cheratina dura"], cat:"Base" },
            { q: "Una pustola √®:", a: ["Lesione contenente pus", "Lesione piana", "Cicatrice", "Ulcera profonda"], cat:"Base" },
            { q: "La placca √® spesso:", a: ["Confluenza di papule (rilevata e ampia)", "Solo una macula", "Solo un nodulo", "Un'ulcera"], cat:"Base" }
          ],
          "Diagnosi rapide": [
            { q: "Orticaria tipicamente presenta:", a: ["Pomfi pruriginosi migranti", "Comedoni", "Vescicole dolorose lungo un dermatomero", "Placche argentate croniche"], cat:"Clinica" },
            { q: "Psoriasi tipica:", a: ["Placche eritemato-desquamative", "Bolle flaccide diffuse", "Macchie ipopigmentate isolate", "Lesioni purulente in piega"], cat:"Clinica" },
            { q: "Herpes zoster:", a: ["Vescicole dolorose a distribuzione metamerica", "Papule acneiche", "Macule diffuse non dolorose", "Orticaria migrante"], cat:"Clinica" },
            { q: "Tinea corporis spesso d√†:", a: ["Lesione anulare con bordo attivo desquamante", "Pomfi migranti", "Bolle emorragiche", "Ulcere necrotiche"], cat:"Infettive" },
            { q: "La scabbia causa:", a: ["Prurito notturno + cunicoli", "Alopecia a chiazze", "Iperidrosi isolata", "Teleangectasie diffuse"], cat:"Infettive" }
          ]
        }
      }
    };

    /***********************************************************************
     * STATE
     **********************************************************************/
    const state = {
      isLogged: false,
      currentUser: null,
      profile: null,

      currentCourseId: null,
      selectedModules: new Set(),

      // search
      searchHits: [],
      searchLastQuery: "",
      searchLastResultIds: [],

      // quiz
      mode: null, // modules | course_exam | wrong | old | search
      quizQuestions: [],
      quizIndex: 0,
      quizCorrect: 0,
      quizAnswered: false,

      // settings modal
      pendingMode: null
    };

    // Q map for stable qids
    const QMAP = {};
    buildQuestionMaps();

    function buildQuestionMaps(){
      for (const cId of Object.keys(QUIZ_PACKS)){
        QMAP[cId] = {};
        const pack = QUIZ_PACKS[cId];
        const mods = pack.modules || {};
        for (const mod of Object.keys(mods)){
          mods[mod].forEach((qq) => {
            const qid = makeQid(cId, mod, qq.q);
            QMAP[cId][qid] = { module: mod, cat: qq.cat || mod, q: qq.q, a: qq.a, correct: (typeof qq.correct === "number" ? qq.correct : null) };
          });
        }
      }
    }

    /***********************************************************************
     * DOM refs
     **********************************************************************/
    const crumbEl = document.getElementById("crumb");
    const chipAuth = document.getElementById("chip-auth");

    // views
    const vDashboard = document.getElementById("view-dashboard");
    const vCourse = document.getElementById("view-course");
    const vQuiz = document.getElementById("view-quiz");
    const vResults = document.getElementById("view-results");

    // dashboard
    const coursesGrid = document.getElementById("courses-grid");

    // course
    const courseTitle = document.getElementById("course-title");
    const courseDesc = document.getElementById("course-desc");
    const modulesList = document.getElementById("modules-list");

    const statAvg = document.getElementById("stat-avg");
    const statDone = document.getElementById("stat-done");
    const statAvgSub = document.getElementById("stat-avg-sub");
    const statDoneSub = document.getElementById("stat-done-sub");

    const lockedHint = document.getElementById("locked-hint");
    const btnWrong = document.getElementById("btn-wrong");
    const btnOld = document.getElementById("btn-old");
    const wrongCountEl = document.getElementById("wrong-count");
    const oldestLabelEl = document.getElementById("oldest-label");

    const panelModules = document.getElementById("panel-modules");
    const moduleListEl = document.getElementById("moduleList");

    const searchEl = document.getElementById("search");
    const searchResultsEl = document.getElementById("searchResults");
    const btnSearchStart = document.getElementById("btn-search-start");

    // float bar
    const courseActions = document.getElementById("course-actions");
    const selCountEl = document.getElementById("sel-count");
    const btnStart = document.getElementById("btn-start");
    const quizActions = document.getElementById("quiz-actions");
    const btnNext = document.getElementById("btn-next");
    const btnSkip = document.getElementById("btn-skip");

    // quiz
    const qChip = document.getElementById("q-chip");
    const qCounter = document.getElementById("q-counter");
    const progressBar = document.getElementById("progress-bar");
    const qText = document.getElementById("q-text");
    const optionsContainer = document.getElementById("options-container");

    // results
    const finalScore = document.getElementById("final-score");
    const finalMsg = document.getElementById("final-msg");

    // auth / account UI
    const vAuth = document.getElementById("view-auth");
    const userDisplay = document.getElementById("user-display");
    const userDisplayDash = document.getElementById("user-display-dash");
    const profileLoggedOut = document.getElementById("profile-loggedout");
    const profileLoggedIn = document.getElementById("profile-loggedin");
    const dashLoggedOut = document.getElementById("dash-loggedout");
    const dashLoggedIn = document.getElementById("dash-loggedin");

    // auth
    const authTitle = document.getElementById("auth-title");
    const authSub = document.getElementById("auth-sub");
    const authError = document.getElementById("auth-error");
    const authLogin = document.getElementById("auth-login");
    const authSignup = document.getElementById("auth-signup");

    // settings
    const settingsModal = document.getElementById("settings-modal");
    const settingsDesc = document.getElementById("settings-desc");
    const settingsLimit = document.getElementById("settings-limit");
    const settingsError = document.getElementById("settings-error");

    /***********************************************************************
     * Init
     **********************************************************************/
    renderCourses();
    refreshSelectionBar();
    wireAuthEnterKeys();

    // Prevent layout/scroll glitches after refresh
    try{ if ("scrollRestoration" in history) history.scrollRestoration = "manual"; }catch(e){}
    try{ window.scrollTo(0,0); }catch(e){}
    try{ document.querySelectorAll(".view").forEach(v=> v.scrollTop = 0); }catch(e){}

    if (!supa){
      console.warn("Supabase non configurato: inserisci SUPABASE_URL e SUPABASE_ANON_KEY.");
      setAuthUI(null);
    } else {
      initAuth();
    }

    window.addEventListener("resize", () => {
      try{ drawProgressChart(__progressPoints); }catch(e){}
      try{ drawModuleChart(__moduleLabels, __moduleValues); }catch(e){}
    });

    /***********************************************************************
     * Navigation
     **********************************************************************/
    function navTo(viewId){
      const views = Array.from(document.querySelectorAll(".view"));
      views.forEach(el => el.classList.remove("active"));
      const target = document.getElementById("view-" + viewId);
      if (!target){
        console.warn("View non trovata:", viewId);
        return;
      }
      target.classList.add("active");

      // hard safety: in caso di glitch/duplicati, garantisci UNA sola view attiva
      views.forEach(v => { if (v !== target) v.classList.remove("active"); });

      // keep layout stable (avoid cropped header / "storto" after refresh)
      if (viewId === "auth" || viewId === "dashboard"){
        try{ target.scrollTop = 0; }catch(e){}
        try{ window.scrollTo(0,0); }catch(e){}
      }

      // se stai uscendo dall'area account, nascondi eventuali pannelli di successo
      if (viewId !== "auth"){
        try{ hideAuthSuccess(); }catch(e){}
      }

      // floating bars
      try{ courseActions && courseActions.classList.remove("visible"); }catch(e){}
      try{ quizActions && quizActions.classList.remove("visible"); }catch(e){}

      if (viewId === "course"){
        courseActions.classList.add("visible");
      }
    }

    function goHome(){
      if (vQuiz.classList.contains("active")){
        if(!confirm("Vuoi uscire dal quiz? Perderai i progressi di questa sessione.")) return;
      }
      state.currentCourseId = null;
      state.selectedModules.clear();
      crumbEl.textContent = "Corsi";
      navTo("dashboard");
    }

    function backToCourse(){
      if (!state.currentCourseId){ goHome(); return; }
      navTo("course");
      refreshCourseDashboard();
    }

    /***********************************************************************
     * Dashboard: courses
     **********************************************************************/
    function renderCourses(){
      coursesGrid.innerHTML = "";
      Object.values(QUIZ_PACKS).forEach(c => {
        const qCount = Object.values(c.modules || {}).reduce((acc, a)=> acc + a.length, 0);
        const mCount = Object.keys(c.modules).length;

        const card = document.createElement("div");
        card.className = "glass-panel course-card";
        card.onclick = () => openCourse(c.id);

        card.innerHTML = `
          <div>
            <div class="course-icon">${c.icon || "üìö"}</div>
            <div class="course-info">
              <h3>${escapeHtml(c.title)}</h3>
              <p>${escapeHtml(c.desc || "")}</p>
            </div>
          </div>
          <div class="course-stats">
            <span class="badge">${mCount} Moduli</span>
            <span class="badge">${qCount} Domande</span>
            <span class="badge">${state.isLogged ? "Progressi attivi" : "Login opzionale"}</span>
          </div>
        `;
        coursesGrid.appendChild(card);
      });
    }

    function openCourse(courseId){
      state.currentCourseId = courseId;
      state.selectedModules.clear();
      state.searchHits = [];
      state.searchLastQuery = "";
      state.searchLastResultIds = [];
      searchEl.value = "";
      searchResultsEl.innerHTML = "";
      btnSearchStart.disabled = true;
      btnSearchStart.textContent = "Quiz dalla ricerca";

      const c = QUIZ_PACKS[courseId];
      crumbEl.textContent = `Corsi ‚Ä¢ ${c.title}`;
      courseTitle.textContent = c.title;
      courseDesc.textContent = c.desc || "";

      renderModulesSelection();
      refreshSelectionBar();
      navTo("course");
      refreshCourseDashboard();
    }

    /***********************************************************************
     * Modules selection
     **********************************************************************/
    function renderModulesSelection(){
      modulesList.innerHTML = "";
      const course = QUIZ_PACKS[state.currentCourseId];
      const mods = Object.keys(course.modules || {});

      mods.forEach(m => {
        const item = document.createElement("div");
        item.className = "module-item";
        item.onclick = () => toggleModule(m, item);
        item.innerHTML = `
          <div class="m-title">${escapeHtml(m)}</div>
          <div class="m-sub">${course.modules[m].length} domande</div>
        `;
        modulesList.appendChild(item);
      });
    }

    function toggleModule(m, el){
      if (state.selectedModules.has(m)){
        state.selectedModules.delete(m);
        el.classList.remove("selected");
      } else {
        state.selectedModules.add(m);
        el.classList.add("selected");
      }
      refreshSelectionBar();
    }

    function selectAllModules(){
      const course = QUIZ_PACKS[state.currentCourseId];
      state.selectedModules = new Set(Object.keys(course.modules || {}));
      renderModulesSelection();
      // mark all selected
      document.querySelectorAll(".module-item").forEach(el => el.classList.add("selected"));
      refreshSelectionBar();
    }

    function clearModules(){
      state.selectedModules.clear();
      document.querySelectorAll(".module-item").forEach(el => el.classList.remove("selected"));
      refreshSelectionBar();
    }

    function refreshSelectionBar(){
      const count = countSelectedQuestions();
      selCountEl.textContent = String(count);
      btnStart.disabled = state.selectedModules.size === 0;
    }

    function countSelectedQuestions(){
      if (!state.currentCourseId) return 0;
      const course = QUIZ_PACKS[state.currentCourseId];
      let count = 0;
      state.selectedModules.forEach(m => count += ((course.modules || {})[m]?.length || 0));
      return count;
    }

    /***********************************************************************
     * Search (within course)
     **********************************************************************/
    function onSearch(){
      const q = (searchEl.value || "").trim().toLowerCase();
      const map = QMAP[state.currentCourseId] || {};

      // reset when query cleared
      if (!q || q.length < 2){
        state.searchLastQuery = "";
        state.searchLastResultIds = [];
        state.searchHits = [];
        searchResultsEl.innerHTML = "";
        btnSearchStart.disabled = true;
        btnSearchStart.textContent = "Quiz dalla ricerca";
        return;
      }

      // if query changed, reset manual selection
      if (q !== state.searchLastQuery){
        state.searchHits = [];
        state.searchLastQuery = q;
      }

      const hits = Object.entries(map)
        .map(([qid, obj]) => ({ qid, ...obj }))
        .filter(x =>
          (x.q || "").toLowerCase().includes(q) ||
          (x.cat || "").toLowerCase().includes(q) ||
          (x.module || "").toLowerCase().includes(q)
        )
        .slice(0, 60);

      state.searchLastResultIds = hits.map(h => h.qid);

      searchResultsEl.innerHTML = "";

      hits.forEach(h => {
        const card = document.createElement("div");
        card.className = "glass-panel search-card";
        card.style.borderRadius = "20px";
        card.style.padding = "14px";
        card.style.cursor = "pointer";

        const selected = state.searchHits.includes(h.qid);
        if (selected) card.classList.add("selected");

        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
            <div style="font-weight:850;">${escapeHtml(trim(h.q, 120))}</div>
            <span class="badge" style="white-space:nowrap;">${escapeHtml(h.module)}</span>
          </div>
          <div style="margin-top:8px;color:var(--text-sec);font-weight:750;">${escapeHtml(h.cat || "")}</div>
          <div data-cta style="margin-top:10px;color:${selected ? "var(--primary)" : "var(--text-sec)"};font-weight:850;">
            ${selected ? "‚úì Aggiunta al quiz" : "Clicca per aggiungere"}
          </div>
        `;

        card.onclick = () => {
          if (state.searchHits.includes(h.qid)){
            state.searchHits = state.searchHits.filter(x => x !== h.qid);
            card.classList.remove("selected");
          } else {
            state.searchHits.push(h.qid);
            card.classList.add("selected");
          }

          const cta = card.querySelector("[data-cta]");
          if (cta){
            const nowSel = state.searchHits.includes(h.qid);
            cta.textContent = nowSel ? "‚úì Aggiunta al quiz" : "Clicca per aggiungere";
            cta.style.color = nowSel ? "var(--primary)" : "var(--text-sec)";
          }

          updateSearchStartButton();
        };

        searchResultsEl.appendChild(card);
      });

      updateSearchStartButton();

      function updateSearchStartButton(){
        const total = state.searchLastResultIds.length;
        const sel = state.searchHits.length;
        btnSearchStart.disabled = total === 0;
        btnSearchStart.textContent = sel > 0 ? `Quiz dalla ricerca (${sel})` : `Quiz con tutti i risultati (${total})`;
      }
    }

    /***********************************************************************
     * Course dashboard (Supabase data)
     **********************************************************************/
    let progressType = "line";
    let __progressPoints = [];
    let __moduleLabels = [];
    let __moduleValues = [];

    function setProgressType(type){
      progressType = type;
      document.getElementById("btn-line").classList.toggle("active", type==="line");
      document.getElementById("btn-bar").classList.toggle("active", type==="bar");
      drawProgressChart(__progressPoints);
    }

    async function refreshCourseDashboard(){
      // reset UI
      lockedHint.style.display = "none";
      btnWrong.disabled = true;
      btnOld.disabled = true;
      wrongCountEl.textContent = "‚Äî";
      oldestLabelEl.textContent = "‚Äî";
      panelModules.classList.add("hidden");
      drawProgressChart([]);

      if (!state.isLogged || !supa){
        statAvg.textContent = "‚Äî%";
        statDone.textContent = "‚Äî";
        statAvgSub.textContent = "Accedi per vedere la tua media in questo corso.";
        statDoneSub.textContent = "Accedi per vedere la cronologia dei quiz.";
        lockedHint.style.display = "block";
        return;
      }

      const courseId = state.currentCourseId;

      // attempts
      const { data: attempts, error: aErr } = await supa
        .from("quiz_attempts")
        .select("percent, created_at")
        .eq("user_id", state.currentUser.id)
        .eq("course_id", courseId)
        .order("created_at", { ascending: true })
        .limit(30);

      if (aErr) console.warn(aErr);

      const perc = (attempts || []).map(r => ({ percent: r.percent, created_at: r.created_at }));
      __progressPoints = perc;
      drawProgressChart(perc);

      const avg = perc.length ? Math.round(perc.reduce((s,o)=>s+(o.percent||0),0)/perc.length) : 0;
      statAvg.textContent = perc.length ? `${avg}%` : "‚Äî%";
      statAvgSub.textContent = perc.length ? `Basata su ${perc.length} quiz.` : "Non hai ancora quiz salvati in questo corso.";

      statDone.textContent = String((attempts || []).length);
      statDoneSub.textContent = "Quiz registrati (ultimi 30).";

      // question progress
      const { data: qp, error: qErr } = await supa
        .from("question_progress")
        .select("qid, module, correct, wrong, attempts, last_seen, last_wrong")
        .eq("user_id", state.currentUser.id)
        .eq("course_id", courseId);

      if (qErr) console.warn(qErr);

      const rows = qp || [];
      const wrongRows = rows.filter(r => (r.wrong || 0) > 0);
      wrongCountEl.textContent = String(wrongRows.length);
      btnWrong.disabled = wrongRows.length === 0;

      // oldest
      let oldest = null;
      for (const r of rows){
        const t = r.last_seen ? new Date(r.last_seen).getTime() : 0;
        if (!oldest || t < oldest.t){
          oldest = { t, qid: r.qid };
        }
      }
      if (oldest){
        const qObj = QMAP[courseId]?.[oldest.qid];
        oldestLabelEl.textContent = qObj ? `${qObj.module} ‚Ä¢ ${trim(qObj.q, 44)}` : "‚Äî";
        btnOld.disabled = rows.length === 0;
      } else {
        oldestLabelEl.textContent = "‚Äî";
        btnOld.disabled = true;
      }

      // module aggregation
      const modAgg = {};
      for (const r of rows){
        const m = r.module || "Senza modulo";
        if (!modAgg[m]) modAgg[m] = { c:0, a:0 };
        modAgg[m].c += (r.correct || 0);
        modAgg[m].a += (r.attempts || 0);
      }
      const labels = Object.keys(modAgg).sort((a,b)=>a.localeCompare(b));
      if (labels.length){
        const vals = labels.map(l => {
          const a = modAgg[l].a || 0;
          const c = modAgg[l].c || 0;
          return a ? Math.round((c/a)*100) : 0;
        });
        __moduleLabels = labels;
        __moduleValues = vals;
        panelModules.classList.remove("hidden");
        drawModuleChart(labels, vals);
        renderModuleList(labels, vals);
      }
    }

    function renderModuleList(labels, vals){
      moduleListEl.innerHTML = "";
      labels.forEach((l,i)=>{
        const row = document.createElement("div");
        row.className = "module-row";
        row.innerHTML = `<div>${escapeHtml(l)}</div><div class="val">${vals[i]}%</div>`;
        moduleListEl.appendChild(row);
      });
    }

    /***********************************************************************
     * Quiz settings flow (choose question count INSIDE start)
     **********************************************************************/
    function setQuickLimit(n){
      settingsLimit.value = String(n);
    }

    function setOldDays(n){
      const el = document.getElementById("settings-old-days");
      if (el) el.value = String(n);
    }

    function openQuizSettings(mode){
      // login gate for modes that require data
      if ((mode === "wrong" || mode === "old") && !state.isLogged){
        openAuth("login");
        return;
      }
      if (mode === "search" && state.searchHits.length === 0 && (state.searchLastResultIds||[]).length === 0) return;

      state.pendingMode = mode;

      // extra settings per modalit√†
      const oldWrap = document.getElementById("settings-old-wrap");
      if (oldWrap) oldWrap.classList.toggle("hidden", mode !== "old");

      // describe
      const course = QUIZ_PACKS[state.currentCourseId];
      const selCount = countSelectedQuestions();
      const totalCourse = Object.values(course.modules).reduce((s,a)=>s+a.length,0);

      let base = "";
      if (mode === "modules") base = `Quiz dai moduli selezionati (${selCount} disponibili).`;
      else if (mode === "course_exam") base = `Simulazione corso (tutti i moduli, ${totalCourse} domande).`;
      else if (mode === "wrong") base = `Quiz dagli errori recenti (solo questo corso).`;
      else if (mode === "old") base = `Ripasso delle domande pi√π vecchie (solo questo corso).`;
      else if (mode === "search"){
        const sel = state.searchHits.length;
        const total = (state.searchLastResultIds||[]).length;
        base = sel ? `Quiz dalle domande selezionate in ricerca (${sel}).` : `Quiz da tutti i risultati ricerca (${total}).`;
      }

      settingsDesc.textContent = base + " Scegli quante domande vuoi fare.";

      settingsError.style.display = "none";
      settingsError.textContent = "";

      settingsModal.classList.add("active");
      // focus
      setTimeout(()=> settingsLimit.focus(), 50);
    }

    function closeSettings(){
      settingsModal.classList.remove("active");
      state.pendingMode = null;
    }

    async function startFromSettings(){
      const mode = state.pendingMode;
      if (!mode){ closeSettings(); return; }

      const raw = parseInt(settingsLimit.value || "20", 10);
      const limit = isNaN(raw) ? 20 : Math.max(0, raw);

      // gather questions
      let qs = [];
      let modulesLabel = [];

      const course = QUIZ_PACKS[state.currentCourseId];

      if (mode === "modules"){
        if (state.selectedModules.size === 0){
          settingsError.textContent = "Seleziona almeno un modulo.";
          settingsError.style.display = "block";
          return;
        }
        const mods = Array.from(state.selectedModules);
        modulesLabel = mods;
        qs = mods.flatMap(m => course.modules[m].map(qq => QMAP[state.currentCourseId][makeQid(state.currentCourseId, m, qq.q)]));
      }

      if (mode === "course_exam"){
        const mods = Object.keys(course.modules || {});
        modulesLabel = mods;
        qs = mods.flatMap(m => course.modules[m].map(qq => QMAP[state.currentCourseId][makeQid(state.currentCourseId, m, qq.q)]));
      }

      if (mode === "search"){
        modulesLabel = ["Ricerca"];
        const ids = state.searchHits.length ? state.searchHits : (state.searchLastResultIds || []);
        qs = ids.map(qid => QMAP[state.currentCourseId][qid]).filter(Boolean);
      }

      if (mode === "wrong"){
        if (!supa || !state.isLogged) return;
        const { data, error } = await supa
          .from("question_progress")
          .select("qid, last_wrong, wrong")
          .eq("user_id", state.currentUser.id)
          .eq("course_id", state.currentCourseId)
          .gt("wrong", 0)
          .order("last_wrong", { ascending: false })
          .limit(250);

        if (error){
          settingsError.textContent = "Errore nel caricare gli errori.";
          settingsError.style.display = "block";
          return;
        }
        modulesLabel = ["Errori"];
        qs = (data || []).map(r => QMAP[state.currentCourseId][r.qid]).filter(Boolean);
      }

      if (mode === "old"){
        if (!supa || !state.isLogged) return;

        const daysEl = document.getElementById("settings-old-days");
        const includeEl = document.getElementById("settings-old-unseen");
        const daysRaw = parseInt(daysEl?.value || "14", 10);
        const days = isNaN(daysRaw) ? 14 : Math.max(0, daysRaw);
        const includeUnseen = includeEl ? !!includeEl.checked : true;

        const { data, error } = await supa
          .from("question_progress")
          .select("qid, last_seen")
          .eq("user_id", state.currentUser.id)
          .eq("course_id", state.currentCourseId)
          .limit(5000);

        if (error){
          settingsError.textContent = "Errore nel caricare il ripasso.";
          settingsError.style.display = "block";
          return;
        }

        const lastSeenByQid = new Map((data || []).map(r => [r.qid, r.last_seen]));
        const cutoffMs = Date.now() - (days * 86400000);

        const map = QMAP[state.currentCourseId] || {};
        const eligible = Object.keys(map).filter((qid) => {
          const last = lastSeenByQid.get(qid);
          if (!last) return includeUnseen;
          const t = new Date(last).getTime();
          if (!t) return includeUnseen;
          return days === 0 ? true : (t <= cutoffMs);
        });

        // unseen first, then oldest seen
        eligible.sort((a,b) => {
          const la = lastSeenByQid.get(a);
          const lb = lastSeenByQid.get(b);
          if (!la && !lb) return 0;
          if (!la) return -1;
          if (!lb) return 1;
          return new Date(la).getTime() - new Date(lb).getTime();
        });

        modulesLabel = ["Ripasso"];
        qs = eligible.map(qid => map[qid]).filter(Boolean);
      }

      // start quiz
      closeSettings();
      state.mode = mode;
      startQuiz(qs, modulesLabel, limit);
    }

    /***********************************************************************
     * Quiz engine (with limit)
     **********************************************************************/
    function startQuiz(qs, modulesLabel, limit){
      // dedup
      const seen = new Set();
      let qList = qs
        .filter(Boolean)
        .filter(x => typeof x.q === "string" && x.q.trim().length)
        .filter(x => Array.isArray(x.a) && x.a.length >= 2)
        .filter(x => {
        if (seen.has(x.q)) return false;
        seen.add(x.q);
        return true;
      });

      // shuffle questions
      qList = shuffle(qList);

      if (limit > 0) qList = qList.slice(0, limit);

      if (!qList.length){
        alert("Non ci sono domande disponibili per questa modalit√†.");
        return;
      }

      // build session questions with shuffled options
      state.quizQuestions = qList.map(x => {
        const baseCorrectIndex = (typeof x.correct === "number" && x.correct >= 0 && x.correct < x.a.length) ? x.correct : 0;
        const correctText = x.a[baseCorrectIndex];
        const opts = shuffle([...x.a]);
        let correctIndex = opts.indexOf(correctText);
        if (correctIndex < 0) correctIndex = 0;
        return {
          course_id: state.currentCourseId,
          qid: makeQid(state.currentCourseId, x.module, x.q),
          module: x.module,
          cat: x.cat || x.module,
          q: x.q,
          options: opts,
          correctIndex
        };
      });

      state.quizIndex = 0;
      state.quizCorrect = 0;
      state.quizAnswered = false;

      // UI
      crumbEl.textContent = `Corsi ‚Ä¢ ${QUIZ_PACKS[state.currentCourseId].title} ‚Ä¢ Quiz`;
      navTo("quiz");
      renderQuestion();
    }

    function renderQuestion(){
      if (state.quizIndex >= state.quizQuestions.length){
        finishQuiz();
        return;
      }

      state.quizAnswered = false;

      const q = state.quizQuestions[state.quizIndex];
      qChip.textContent = `${QUIZ_PACKS[state.currentCourseId].icon} ${q.module}`;
      qCounter.textContent = `${state.quizIndex + 1} / ${state.quizQuestions.length}`;
      progressBar.style.width = `${(state.quizIndex / state.quizQuestions.length) * 100}%`;

      qText.textContent = q.q;
      optionsContainer.innerHTML = "";

      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "opt-btn";
        btn.textContent = opt;
        btn.onclick = () => handleAnswer(idx, btn);
        optionsContainer.appendChild(btn);
      });

      if (btnNext){
        btnNext.disabled = true;
        btnNext.textContent = (state.quizIndex === state.quizQuestions.length - 1) ? "Termina ‚Üí" : "Prossima ‚Üí";
      }
    }

    function handleAnswer(idx, btn){
      if (state.quizAnswered) return;

      try{
        state.quizAnswered = true;

        const q = state.quizQuestions[state.quizIndex];
        const buttons = Array.from(document.querySelectorAll(".opt-btn"));
        buttons.forEach(b => b.disabled = true);

        const safeCorrectIndex =
          (Number.isInteger(q.correctIndex) && q.correctIndex >= 0 && q.correctIndex < buttons.length)
            ? q.correctIndex
            : 0;

        const isCorrect = idx === safeCorrectIndex;
        if (isCorrect){
          btn.classList.add("correct");
          state.quizCorrect++;
        } else {
          btn.classList.add("wrong");
          if (buttons[safeCorrectIndex]) buttons[safeCorrectIndex].classList.add("correct");
        }

        // abilita subito "Prossima" (NON aspettare Supabase: evita blocchi/lag)
        if (btnNext) btnNext.disabled = false;

        // salva progress per domanda in background (solo se logged)
        if (state.isLogged && supa){
          Promise.resolve(
            supa.rpc("record_question_attempt", {
              p_course_id: q.course_id,
              p_qid: q.qid,
              p_module: q.module,
              p_cat: q.cat,
              p_is_correct: isCorrect
            })
          ).catch(e => console.warn("record_question_attempt error", e));
        }
      }catch(e){
        console.error("handleAnswer fatal", e);
        // fail-safe: non bloccare MAI il quiz
        state.quizAnswered = true;
        if (btnNext) btnNext.disabled = false;
      }
    } else {
        btn.classList.add("wrong");
        if (buttons[safeCorrectIndex]) buttons[safeCorrectIndex].classList.add("correct");
      }

      // save progress per question (only if logged)
      if (state.isLogged && supa){
        try{
          await supa.rpc("record_question_attempt", {
            p_course_id: q.course_id,
            p_qid: q.qid,
            p_module: q.module,
            p_cat: q.cat,
            p_is_correct: isCorrect
          });
        }catch(e){
          console.warn("record_question_attempt error", e);
        }
      }

      // (legacy)
    }

    function nextQuestion(){
      if (!vQuiz.classList.contains("active")) return;

      // anti double-click / glitch
      if (state._nextLock) return;
      state._nextLock = true;
      setTimeout(()=>{ state._nextLock = false; }, 200);

      // di norma "Prossima" √® disabilitato finch√© non rispondi.
      // Questo fallback evita blocchi se qualcuno forza il click.
      if (!state.quizAnswered){
        if(!confirm("Vuoi saltare questa domanda?")){ state._nextLock = false; return; }
      }

      state.quizIndex++;
      renderQuestion();
    }

    function skipQuestion(){
      if (!vQuiz.classList.contains("active")) return;
      if(!confirm("Vuoi saltare questa domanda?")) return;
      state.quizIndex++;
      renderQuestion();
    }
      state.quizIndex++;
      renderQuestion();
    }

    function quitQuiz(){
      if(confirm("Vuoi uscire? Perderai i progressi di questa sessione.")){
        backToCourse();
      }
    }

    async function finishQuiz(){
      const pct = Math.round((state.quizCorrect / state.quizQuestions.length) * 100);
      finalScore.textContent = pct + "%";

      let msg = "Puoi fare di meglio.";
      if (pct >= 60) msg = "Buon risultato.";
      if (pct >= 80) msg = "Ottimo lavoro.";
      if (pct >= 90) msg = "Eccellente!";
      finalMsg.textContent = msg;

      progressBar.style.width = "100%";
      navTo("results");

      // save attempt
      if (state.isLogged && supa){
        try{
          const modules = [...new Set(state.quizQuestions.map(x => x.module))];
          await supa.from("quiz_attempts").insert({
            user_id: state.currentUser.id,
            course_id: state.currentCourseId,
            mode: state.mode,
            modules,
            total: state.quizQuestions.length,
            correct: state.quizCorrect,
            percent: pct
          });
        }catch(e){
          console.warn("quiz_attempts insert error", e);
        }
      }

      // update dashboard when returning
    }

    /***********************************************************************
     * Charts (HiDPI, Apple colors)
     **********************************************************************/
    function setupCanvas(canvas, cssHeight){
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width));
      const h = Math.max(1, Math.floor(cssHeight));

      canvas.style.height = h + "px";
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);

      return { ctx, w, h };
    }

    function drawGrid(ctx,w,h){
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle = "rgba(0,0,0,0.08)";
      ctx.lineWidth = 1;
      for (let i=0;i<=4;i++){
        const y = (h/4)*i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(w,y);
        ctx.stroke();
      }
    }

    function drawProgressChart(points){
      const canvas = document.getElementById("progressChart");
      if (!canvas) return;

      // normalize: allow [number] or [{v,t}] or [{percent,created_at}]
      const arr = (points || []).map(p => {
        if (typeof p === "number") return { v: p, t: null };
        return {
          v: (p && (p.v ?? p.percent ?? 0)) | 0,
          t: p?.t ?? p?.created_at ?? null
        };
      });

      const { ctx, w, h } = setupCanvas(canvas, 140);
      drawGrid(ctx,w,h);

      const primary = getComputedStyle(document.documentElement).getPropertyValue("--primary").trim() || "#0071e3";
      const sec = getComputedStyle(document.documentElement).getPropertyValue("--text-sec").trim() || "#86868b";
      const font = getComputedStyle(document.body).fontFamily;

      if (!arr.length){
        ctx.fillStyle = sec;
        ctx.font = "800 12px " + font;
        ctx.fillText("Fai un quiz (loggato) per riempire il grafico.", 10, h/2);
        return;
      }

      const padX=10, padY=14;
      const innerW = w - padX*2;
      const innerH = h - padY*2;

      const n = Math.min(arr.length, 30);
      const data = arr.slice(-n);
      const xs = data.map((_,i) => padX + (innerW * (n===1 ? 0 : i/(n-1))));
      const ys = data.map(d => padY + innerH * (1 - (Math.max(0, Math.min(100, d.v)) / 100)));

      // subtle fill
      const grad = ctx.createLinearGradient(0, padY, 0, padY + innerH);
      grad.addColorStop(0, "rgba(0,113,227,0.18)");
      grad.addColorStop(1, "rgba(0,113,227,0.02)");

      if (progressType === "bar"){
        const barW = innerW / n;
        for (let i=0;i<n;i++){
          const x = padX + i*barW + 3;
          const y = ys[i];
          const bw = Math.max(2, barW - 6);
          const bh = (padY + innerH) - y;

          ctx.fillStyle = "rgba(0,113,227,0.35)";
          ctx.beginPath();
          const r = 6;
          ctx.moveTo(x, y + r);
          ctx.arcTo(x, y, x + r, y, r);
          ctx.lineTo(x + bw - r, y);
          ctx.arcTo(x + bw, y, x + bw, y + r, r);
          ctx.lineTo(x + bw, y + bh);
          ctx.lineTo(x, y + bh);
          ctx.closePath();
          ctx.fill();
        }
      } else {
        // area
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(xs[0], padY + innerH);
        ctx.lineTo(xs[0], ys[0]);

        for (let i=1;i<n;i++){
          const xc = (xs[i-1] + xs[i]) / 2;
          const yc = (ys[i-1] + ys[i]) / 2;
          ctx.quadraticCurveTo(xs[i-1], ys[i-1], xc, yc);
        }
        ctx.lineTo(xs[n-1], ys[n-1]);
        ctx.lineTo(xs[n-1], padY + innerH);
        ctx.closePath();
        ctx.fill();

        // stroke
        ctx.strokeStyle = primary;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(xs[0], ys[0]);
        for (let i=1;i<n;i++){
          const xc = (xs[i-1] + xs[i]) / 2;
          const yc = (ys[i-1] + ys[i]) / 2;
          ctx.quadraticCurveTo(xs[i-1], ys[i-1], xc, yc);
        }
        ctx.lineTo(xs[n-1], ys[n-1]);
        ctx.stroke();

        // points
        for (let i=0;i<n;i++){
          ctx.fillStyle = "white";
          ctx.strokeStyle = primary;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(xs[i], ys[i], 3.2, 0, Math.PI*2);
          ctx.fill();
          ctx.stroke();
        }
      }

      // labels (first/last date if available)
      const t0 = data[0].t ? new Date(data[0].t) : null;
      const t1 = data[n-1].t ? new Date(data[n-1].t) : null;

      ctx.fillStyle = sec;
      ctx.font = "800 11px " + font;
      const lastVal = data[n-1].v;
      ctx.fillText(`${lastVal}%`, Math.max(8, xs[n-1]-18), Math.max(14, ys[n-1]-10));

      if (t0 && t1){
        const fmt = (d)=> String(d.getDate()).padStart(2,"0") + "/" + String(d.getMonth()+1).padStart(2,"0");
        ctx.fillText(fmt(t0), padX, h-6);
        const s = fmt(t1);
        const tw = ctx.measureText(s).width;
        ctx.fillText(s, w - padX - tw, h-6);
      }
    }

function drawModuleChart(labels, vals){
      const canvas = document.getElementById("moduleChart");
      if (!canvas) return;
      const { ctx, w, h } = setupCanvas(canvas, 180);
      drawGrid(ctx,w,h);

      const primary = getComputedStyle(document.documentElement).getPropertyValue("--primary").trim() || "#0071e3";
      if (!labels || labels.length === 0) return;

      const padX=12, padY=16;
      const innerW = w - padX*2;
      const innerH = h - padY*2;

      const n = labels.length;
      const barW = innerW / n;

      ctx.fillStyle = "rgba(0,113,227,0.70)";
      ctx.strokeStyle = primary;
      for (let i=0;i<n;i++){
        const v = vals[i] || 0;
        const barH = (v/100)*innerH;
        const x = padX + i*barW;
        const y = (h-padY) - barH;
        ctx.globalAlpha = 0.78;
        ctx.fillRect(x+2, y, Math.max(2, barW-4), barH);
        ctx.globalAlpha = 1;
      }
    }

    /***********************************************************************
     * Auth (Supabase) ‚Äî refactor v5 (session-driven, no "F5" after logout)
     **********************************************************************/
    function toggleProfile(){
      // legacy: usato in vecchie versioni. Ora la login √® una pagina dedicata.
      openAuth("login");
    }

    function openAuth(tab){
      if (!supa){
        alert("Configura SUPABASE_URL e SUPABASE_ANON_KEY dentro l'HTML.");
        return;
      }

      // memorizza dove tornare dopo login
      const active = document.querySelector(".view.active")?.id || "view-dashboard";
      const from = active.replace("view-","");
      state.afterAuth = (from === "auth") ? "dashboard" : from;

      authError.style.display = "none";
      try{ document.getElementById("btn-resend")?.classList.add("hidden"); }catch(e){}
      try{ document.getElementById("btn-resend-signup")?.classList.add("hidden"); }catch(e){}

      // reset any success panel
      try{ hideAuthSuccess(); }catch(e){}
      authError.textContent = "";

      // mostra pagina account
      navTo("auth");

      if (tab === "signup"){
        authTitle.textContent = "Registrati";
        authSub.textContent = "Crea un account per salvare statistiche e progressi.";
        authSignup.classList.remove("hidden");
        authLogin.classList.add("hidden");
        try{ document.getElementById("signupUser")?.focus(); }catch(e){}
      } else {
        authTitle.textContent = "Accedi";
        authSub.textContent = "Email + password. Statistiche separate per corso.";
        authLogin.classList.remove("hidden");
        authSignup.classList.add("hidden");
        try{ document.getElementById("loginEmail")?.focus(); }catch(e){}
      }

      // mostra pannello corretto
      if (state.isLogged){
        if (profileLoggedOut) profileLoggedOut.classList.add("hidden");
        if (profileLoggedIn) profileLoggedIn.classList.remove("hidden");
      } else {
        if (profileLoggedOut) profileLoggedOut.classList.remove("hidden");
        if (profileLoggedIn) profileLoggedIn.classList.add("hidden");
      }

      // reset bottoni/lock (se una richiesta precedente era rimasta in pending)
      try{
        ["login","signup","resend"].forEach(k=>authUnlock(k));
        const bl = document.getElementById("btn-login");
        if (bl){ bl.disabled = false; bl.textContent = "Accedi"; }
        const bs = document.getElementById("btn-signup");
        if (bs){ bs.disabled = false; bs.textContent = "Crea account"; }
      }catch(e){}

      vAuth.scrollTop = 0;
    }

    function navBackFromAuth(){
      // torna dove eri prima
      navTo(state.afterAuth || "dashboard");
    }

    function closeAuth(){
      navTo(state.afterAuth || "dashboard");
    }

    function showAuthError(msg){
      authError.textContent = safeText(msg, "Errore.");
      authError.style.display = "block";
    }

    function prettyAuthError(err){
      const raw = (err?.message || err?.error_description || "").toLowerCase();


      // Timeout / rete: evita che l‚Äôutente resti bloccato su "Accesso..."
      if (err?.name === "AbortError" || raw.includes("aborted") || raw.includes("abort")) return "Richiesta in timeout: controlla la connessione e riprova.";
      if (raw.includes("failed to fetch") || raw.includes("network") || raw.includes("fetch")) return "Connessione non disponibile: controlla internet e riprova.";
      // Supabase spesso ritorna messaggi "generici" per sicurezza.
      if (raw.includes("invalid login credentials")) return "Email o password non corretti (oppure email non confermata).";
      if (raw.includes("email not confirmed")) return "Email non confermata. Apri la mail di conferma oppure reinviala.";
      if (raw.includes("user already registered")) return "Questa email √® gi√† registrata. Prova ad accedere.";
      if (raw.includes("password") && raw.includes("characters")) return "Password troppo corta.";
      if (raw.includes("rate limit")) return "Troppi tentativi: aspetta un attimo e riprova.";
      return err?.message || "Errore di autenticazione.";
    }

    // Blocchi anti-doppio-submit (evita bug random tipo ‚Äúpassword errata‚Äù per doppio click/Enter)
    const __authLocks = { login:false, signup:false, resend:false };
    function authLock(key){
      if (__authLocks[key]) return false;
      __authLocks[key] = true;
      return true;
    }
    function authUnlock(key){ __authLocks[key] = false; }

    function wireAuthEnterKeys(){
      // Enter = submit (ma senza doppio trigger / key-repeat)
      const bind = (ids, fn) => {
        ids.forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("keydown", (e)=>{
            if (e.key !== "Enter") return;
            if (e.repeat) return;          // niente spam
            e.preventDefault();            // evita doppio submit (form / browser)
            fn();
          });
        });
      };

      try{ bind(["loginEmail","loginPass"], login); }catch(e){}
      try{ bind(["signupUser","signupEmail","signupPass"], signup); }catch(e){}
    }

    function hardClearSupabaseStorage(){
      // Rimuove token/cache Supabase dal browser (utile solo quando si "forza" lo switch account)
      try{
        const ref = (SUPABASE_URL || "").replace(/^https?:\/\//,"").split(".")[0];
        if (!ref) return;
        const prefixes = [
          `sb-${ref}-`, // supabase-js v2
          `supabase.auth.token`, // legacy
        ];

        [localStorage, sessionStorage].forEach(store=>{
          try{
            const keys = [];
            for (let i=0;i<store.length;i++){
              const k = store.key(i);
              if (!k) continue;
              if (prefixes.some(p => k.startsWith(p) || k.includes(p))) keys.push(k);
            }
            keys.forEach(k => store.removeItem(k));
          }catch(e){}
        });
      }catch(e){}
    }

    async function switchAccount(){
      // Chiude la sessione e porta subito al login (pulendo storage solo in questo caso)
      await logout({ silent:true, clearStorage:true, openLogin:true });
    }

    function showLoginSuccess(){
      const user = state.currentUser;
      if (!user) return;
      const uname = state.profile?.username || defaultUsernameFromUser(user);

      showAuthSuccess(
        "Accesso riuscito",
        `Bentornato ${uname}. Le statistiche sono collegate al tuo account.`,
        "Vai ai corsi",
        ()=>{ hideAuthSuccess(); navTo(state.afterAuth || "dashboard"); },
        "Chiudi",
        ()=>{ hideAuthSuccess(); }
      );
    }

    
    async function handleAuthRedirect(){
      // Gestione redirect (email confirmation / OAuth PKCE).
      // - PKCE: ?code=...
      // - Implicit: #access_token=...
      try{
        const url = new URL(window.location.href);
        const code = url.searchParams.get("code");
        if (code){
          const { error } = await supa.auth.exchangeCodeForSession(code);
          if (error) console.warn("exchangeCodeForSession error:", error);
          if (!error) { try{ sessionStorage.setItem("auth_just_confirmed","1"); }catch(e){} }
          // pulisci l'URL (togli code e parametri auth)
          url.searchParams.delete("code");
          url.searchParams.delete("type");
          url.searchParams.delete("token_hash");
          window.history.replaceState({}, document.title, url.toString());
          return;
        }

        // implicit hash tokens: lascia che supabase li legga, poi pulisci hash
        if (window.location.hash && window.location.hash.includes("access_token=")){
          // aspetta un tick: il client legger√† l'hash se detectSessionInUrl = true
          setTimeout(()=>{
            try{
              const clean = new URL(window.location.href);
              clean.hash = "";
              window.history.replaceState({}, document.title, clean.toString());
            }catch(e){}
          }, 50);
        }
      }catch(e){}
    }

    async function resendSignupEmail(fromSignup=false){
      if (!supa) return;
      if (!authLock("resend")) return;
      const email = (
        (fromSignup ? document.getElementById("signupEmail")?.value : document.getElementById("loginEmail")?.value) ||
        document.getElementById("loginEmail")?.value ||
        document.getElementById("signupEmail")?.value ||
        ""
      ).trim().toLowerCase();

      if (!email){
        showAuthError("Inserisci la tua email e poi premi ‚ÄúReinvia email di conferma‚Äù.");
        authUnlock("resend");
        return;
      }

      const btn = fromSignup ? document.getElementById("btn-resend-signup") : document.getElementById("btn-resend");
      if (btn){ btn.disabled = true; btn.textContent = "Invio..."; }

      try{
        const { error } = await supa.auth.resend({
          type: "signup",
          email,
          options: { emailRedirectTo: baseRedirectUrl() }
        });
        if (error) throw error;
        toast("success","Email reinviata","Controlla la posta (anche Spam).");
      }catch(err){
        toast("error","Invio non riuscito", prettyAuthError(err));
      }finally{
        if (btn){ btn.disabled = false; btn.textContent = "Reinvia email di conferma"; }
        authUnlock("resend");
      }
    }

function baseRedirectUrl(){
      // URL "base" della pagina (GitHub Pages compatibile)
      try{
        const u = new URL(window.location.href);
        // es: https://user.github.io/Med/index.html -> https://user.github.io/Med/
        u.hash = "";
        u.search = "";
        const path = u.pathname;
        u.pathname = path.endsWith("/") ? path : path.replace(/\/[^\/]*$/, "/");
        return u.toString();
      }catch(e){
        return window.location.origin + "/";
      }
    }

    function defaultUsernameFromUser(user){
      const meta = user?.user_metadata || {};
      if (meta.username && String(meta.username).trim()) return String(meta.username).trim();
      if (user?.email) return user.email.split("@")[0];
      return "Utente";
    }

    async function ensureProfile(user){
      // Facoltativo: mantiene una tabella profiles per mostrare username e poterlo cambiare in futuro.
      // Se la tabella o le policies non esistono, non blocchiamo l'app.
      try{
        const username = defaultUsernameFromUser(user).slice(0, 40);
        await supa.from("profiles").upsert({ id: user.id, username }, { onConflict: "id" });
      }catch(e){}
    }

    async function signup(){
      if (!authLock("signup")) return;
      authError.style.display = "none";
      try{ document.getElementById("btn-resend-signup")?.classList.add("hidden"); }catch(e){}
      const u = (document.getElementById("signupUser")?.value || "").trim();
      const email = (document.getElementById("signupEmail")?.value || "").trim().toLowerCase();
      const pass = (document.getElementById("signupPass")?.value || "").trim();

      if (!email || !pass){
        showAuthError("Inserisci email e password.");
        authUnlock("signup");
        return;
      }

      const btn = document.getElementById("btn-signup");
      if (btn){ btn.disabled = true; btn.textContent = "Creazione account..."; }

      try{
        const { data, error } = await supa.auth.signUp({
          email,
          password: pass,
          options: {
            data: { username: u || email.split("@")[0] },
            emailRedirectTo: baseRedirectUrl()
          }
        });
        if (error) throw error;

        // Se Email confirmations √® ON, session √® null e bisogna confermare.
        if (data?.session){
          // Profilo (best effort)
          await ensureProfile(data.session.user);
          await applySession(data.session);
          showSignupSuccess();
        } else {
          // non loggato -> serve conferma
          try{ document.getElementById("btn-resend-signup")?.classList.remove("hidden"); }catch(e){}
          showAuthSuccess(
            "Controlla la tua email",
            "Ti abbiamo inviato un link di conferma. Apri il link, poi torna qui e fai login. Se non trovi la mail, puoi reinviarla.",
            "Vai al login",
            ()=>{ hideAuthSuccess(); openAuth("login"); },
            "Reinvia email",
            ()=>{ resendSignupEmail(true); }
          );
          toast("success","Email di conferma inviata","Controlla la posta (anche Spam).");
          }
      }catch(err){
        showAuthError(prettyAuthError(err));
      }finally{
        if (btn){ btn.disabled = false; btn.textContent = "Crea account"; }
        authUnlock("signup");
      }
    }

    async function login(){
      if (!authLock("login")) return;
      authError.style.display = "none";
      try{ document.getElementById("btn-resend")?.classList.add("hidden"); }catch(e){}
      const email = (document.getElementById("loginEmail")?.value || "").trim().toLowerCase();
      const pass = (document.getElementById("loginPass")?.value || "").trim();

      if (!email || !pass){
        showAuthError("Inserisci email e password.");
        authUnlock("login");
        return;
      }

      // Guard: se sei gi√† loggato con un altro account, chiedi switch
      if (state.isLogged && state.currentUser?.email && state.currentUser.email !== email){
        showAuthError("Sei gi√† loggato con un altro account. Premi ‚ÄúCambia account‚Äù per entrare con questa email.");
        authUnlock("login");
        return;
      }

      const btn = document.getElementById("btn-login");
      if (btn){ btn.disabled = true; btn.textContent = "Accesso..."; }

      try{
        const { data, error } = await supa.auth.signInWithPassword({ email, password: pass });
        if (error) {
          // UX: Supabase a volte risponde "Invalid login credentials" anche per email non confermata.
          const msg = (error.message || "").toLowerCase();
          if (msg.includes("email") && (msg.includes("confirm") || msg.includes("confirmed"))){
            showAuthError("Email non confermata. Apri la mail di conferma oppure reinviala.");
            try{ document.getElementById("btn-resend")?.classList.remove("hidden"); }catch(e){}
          } else if (msg.includes("invalid login credentials")){
            showAuthError("Email o password non corretti (oppure email non confermata). Se hai appena creato l‚Äôaccount, reinvia l‚Äôemail di conferma.");
            try{ document.getElementById("btn-resend")?.classList.remove("hidden"); }catch(e){}
          } else {
            showAuthError(prettyAuthError(error));
          }
          return;
        }

        // Profilo (best effort)
        if (data?.user) await ensureProfile(data.user);

        // Aggiorna UI subito (onAuthStateChange far√† comunque il suo lavoro)
        await applySession(data?.session || null);
        showLoginSuccess();
      }catch(err){
        showAuthError(prettyAuthError(err));
      }finally{
        if (btn){ btn.disabled = false; btn.textContent = "Accedi"; }
        authUnlock("login");
      }
    }

    async function logout(opts={}){
      const { silent=false, clearStorage=false, openLogin=false } = opts;

      // UI immediata (evita il "devo fare F5")
      state.isLogged = false;
      state.currentUser = null;
      state.profile = null;
      setAuthUI(null);
      try{ forceResetSessionUI(); }catch(e){}

      try{
        // scope locale: sufficiente per un sito client-side
        await supa.auth.signOut();
      }catch(e){
        // se fallisce, proseguiamo comunque in modalit√† ospite
        console.warn("signOut error:", e);
      }

      if (clearStorage) hardClearSupabaseStorage();

      // riallinea stato sessione (best effort)
      try{ await refreshAuthState(); }catch(e){}

      renderCourses();
      if (vCourse.classList.contains("active")) refreshCourseDashboard();

      // Se user √® su Account, mostra login
      if (vAuth && vAuth.classList.contains("active")){
        try{
          authTitle.textContent = "Accedi";
          authSub.textContent = "Email + password. Statistiche separate per corso.";
          authLogin.classList.remove("hidden");
          authSignup.classList.add("hidden");
          if (profileLoggedOut) profileLoggedOut.classList.remove("hidden");
          if (profileLoggedIn) profileLoggedIn.classList.add("hidden");
          vAuth.scrollTop = 0;
        }catch(e){}
      }

      if (!silent){
        toast("success", "Sei uscito", "Sessione chiusa correttamente. Ora sei in modalit√† ospite.");
      }

      if (openLogin) openAuth("login");
    }

    async function applySession(session){
      const user = session?.user || null;

      state.currentUser = user;
      state.isLogged = !!user;

      if (user){
        // Prova a mantenere un profilo (non bloccare se mancano tabelle/policies)
        await ensureProfile(user);

        try{
          const { data: prof } = await supa
            .from("profiles")
            .select("username")
            .eq("id", user.id)
            .maybeSingle();

          state.profile = prof || { username: defaultUsernameFromUser(user) };
        }catch(e){
          state.profile = { username: defaultUsernameFromUser(user) };
        }
      } else {
        state.profile = null;
      }

      setAuthUI(user);
      renderCourses();
      if (vCourse.classList.contains("active")) refreshCourseDashboard();
    }

    async function refreshAuthState(){
      const { data } = await supa.auth.getSession();
      await applySession(data.session || null);
    }

    let __authSubscription = null;
    async function initAuth(){
      await handleAuthRedirect();
      await refreshAuthState();
      // Se arrivi da conferma email, mostra un feedback chiaro
      try{
        if (sessionStorage.getItem("auth_just_confirmed")==="1"){
          sessionStorage.removeItem("auth_just_confirmed");
          if (state.isLogged){
            toast("success","Email confermata","Ora sei loggato. Puoi tornare ai corsi.", [
              { label:"Vai ai corsi", primary:true, onClick:()=> navTo("dashboard") }
            ]);
          } else {
            toast("success","Email confermata","Ora puoi fare login con email e password.", [
              { label:"Vai al login", primary:true, onClick:()=> openAuth("login") }
            ]);
          }
        }
      }catch(e){}
      try{
        const { data } = supa.auth.onAuthStateChange(async (_event, session) => {
          await applySession(session || null);
        });
        __authSubscription = data?.subscription || null;
      }catch(e){
        // fallback
        console.warn("onAuthStateChange error:", e);
      }
    }

    function setAuthUI(user){
      if (user){
        const uname = state.profile?.username || defaultUsernameFromUser(user);

        if (chipAuth) chipAuth.textContent = "üîì Loggato";
        if (userDisplay) userDisplay.textContent = `${uname} ‚Ä¢ ${user.email || ""}`;
        if (userDisplayDash) userDisplayDash.textContent = `${uname} ‚Ä¢ ${user.email || ""}`;

        if (profileLoggedOut) profileLoggedOut.classList.add("hidden");
        if (profileLoggedIn) profileLoggedIn.classList.remove("hidden");

        if (dashLoggedOut) dashLoggedOut.classList.add("hidden");
        if (dashLoggedIn) dashLoggedIn.classList.remove("hidden");
      } else {
        if (chipAuth) chipAuth.textContent = "üîí Ospite";
        if (userDisplay) userDisplay.textContent = "Ospite (login opzionale)";
        if (userDisplayDash) userDisplayDash.textContent = "Ospite (login opzionale)";

        if (profileLoggedOut) profileLoggedOut.classList.remove("hidden");
        if (profileLoggedIn) profileLoggedIn.classList.add("hidden");

        if (dashLoggedOut) dashLoggedOut.classList.remove("hidden");
        if (dashLoggedIn) dashLoggedIn.classList.add("hidden");
      }
    }
/***********************************************************************
     * In-app feedback (toasts + auth success)
     **********************************************************************/
    const toastStack = document.getElementById("toast-stack");
    const authSuccessBox = document.getElementById("auth-success");
    const authSuccessTitle = document.getElementById("auth-success-title");
    const authSuccessSub = document.getElementById("auth-success-sub");
    const authSuccessPrimaryBtn = document.getElementById("auth-success-primary");
    const authSuccessSecondaryBtn = document.getElementById("auth-success-secondary");

    let __authSuccessPrimaryAction = null;
    let __authSuccessSecondaryAction = null;

    // Evita i classici "[object Object]" in UI (label/notice)
    function safeText(v, fallback=""){
      if (typeof v === "string") return v;
      if (typeof v === "number" || typeof v === "boolean") return String(v);
      return fallback;
    }

    function toast(kind, title, message, actions=[]){
      if (!toastStack) return;
      const el = document.createElement("div");
      el.className = `toast ${kind||""}`.trim();
      el.innerHTML = `
        <div style="padding-left:6px;">
          <h4>${escapeHtml(title||"Info")}</h4>
          <p>${escapeHtml(message||"")}</p>
          <div class="t-actions"></div>
        </div>
        <button class="t-x" aria-label="Chiudi">‚úï</button>
      `;
      const actionsWrap = el.querySelector(".t-actions");
      (actions||[]).slice(0,3).forEach(a=>{
        const b = document.createElement("button");
        b.className = "t-btn" + (a.primary ? " primary" : "");
        b.textContent = safeText(a?.label, "Ok");
        b.onclick = () => { try{ a.onClick && a.onClick(); }catch(e){}; remove(); };
        actionsWrap.appendChild(b);
      });

      const remove = () => {
        el.style.transition = "opacity .18s ease, transform .18s ease";
        el.style.opacity = "0";
        el.style.transform = "translateY(-6px)";
        setTimeout(()=> el.remove(), 180);
      };

      el.querySelector(".t-x").onclick = remove;
      toastStack.appendChild(el);

      // auto-dismiss
      setTimeout(remove, 3800);
    }

    function showAuthSuccess(title, sub, primaryLabel, primaryAction, secondaryLabel, secondaryAction){
      if (!authSuccessBox) return;
      authSuccessTitle.textContent = safeText(title, "Operazione completata");
      authSuccessSub.textContent = safeText(sub, "");
      authSuccessBox.classList.remove("hidden");

      __authSuccessPrimaryAction = primaryAction || null;
      __authSuccessSecondaryAction = secondaryAction || null;

      authSuccessPrimaryBtn.textContent = safeText(primaryLabel, "Vai ai corsi");
      authSuccessSecondaryBtn.textContent = safeText(secondaryLabel, "Accedi");

      // Hide error if visible
      authError.style.display = "none";
      authError.textContent = "";

      // scroll into view
      authSuccessBox.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function hideAuthSuccess(){
      if (!authSuccessBox) return;
      authSuccessBox.classList.add("hidden");
      __authSuccessPrimaryAction = null;
      __authSuccessSecondaryAction = null;
    }

    function authSuccessPrimary(){
      if (__authSuccessPrimaryAction) return __authSuccessPrimaryAction();
      navTo("dashboard");
    }
    function authSuccessSecondary(){
      if (__authSuccessSecondaryAction) return __authSuccessSecondaryAction();
      openAuth("login");
    }

    function showSignupSuccess(){
      // If email confirmation is enabled, session might be null.
      // We'll detect session via current state after refresh.
      (async ()=>{
        await refreshAuthState();
        if (state.isLogged){
          const uname = state.profile?.username || (state.currentUser ? defaultUsernameFromUser(state.currentUser) : "utente");
          showAuthSuccess(
            `Benvenuto, ${uname}`,
            "Account creato con successo. I progressi verranno salvati automaticamente.",
            "Vai ai corsi",
            ()=>{ hideAuthSuccess(); navTo("dashboard"); },
            "Cambia account",
            ()=>{ hideAuthSuccess(); switchAccount(); }
          );
          toast("success","Registrazione completata","Sei gi√† loggato: puoi iniziare subito.");
        } else {
          showAuthSuccess(
            "Controlla la tua email",
            "Ti abbiamo inviato un link di conferma. Apri il link, poi torna qui e fai login. Dopo l'accesso puoi tornare ai corsi.",
            "Vai al login",
            ()=>{ hideAuthSuccess(); openAuth("login"); },
            "Reinvia email",
            ()=>{ resendSignupEmail(true); }
          );
          toast("success","Email di conferma inviata","Controlla la posta (anche Spam).");
        }
      })();
    }

    function forceResetSessionUI(){
      // Reset quiz state (prevents UI inconsistencies after logout)
      state.mode = null;
      state.quizQuestions = [];
      state.quizIndex = 0;
      state.quizCorrect = 0;
      state.quizAnswered = false;

      // reset current course selection (optional but safer)
      state.selectedModules.clear();

      // UI: hide floating quiz bar, ensure we are not stuck in quiz view
      try{ quizActions.classList.remove("visible"); }catch(e){}
      try{ courseActions.classList.remove("visible"); }catch(e){}

      // If currently in quiz view, jump out without confirm
      try{
        if (vQuiz && vQuiz.classList.contains("active")){
          navTo("dashboard");
          state.currentCourseId = null;
          crumbEl.textContent = "Corsi";
        }
      }catch(e){}

      // also, clear any transient DOM that could hide buttons
      try{ optionsContainer.innerHTML = ""; }catch(e){}
      try{ qText.textContent = ""; }catch(e){}
      try{ qCounter.textContent = ""; }catch(e){}
      try{ progressBar.style.width = "0%"; }catch(e){}
    }


/***********************************************************************
     * Utils
     **********************************************************************/
    function shuffle(arr){
      const a = [...arr];
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function trim(s, n){
      if (!s) return "";
      return s.length > n ? s.slice(0,n-1) + "‚Ä¶" : s;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s]));
    }

    function makeQid(courseId, moduleName, qText){
      const base = `${courseId}||${moduleName}||${qText}`.toLowerCase();
      const h = fnv1a(base);
      return `${courseId}:${h}`;
    }

    function fnv1a(str){
      let hash = 0x811c9dc5;
      for (let i=0;i<str.length;i++){
        hash ^= str.charCodeAt(i);
        hash = (hash + ((hash<<1) + (hash<<4) + (hash<<7) + (hash<<8) + (hash<<24))) >>> 0;
      }
      return hash.toString(16).padStart(8,"0");
    }
  </script>

  <!-- Toasts (premium, in-app feedback) -->
  <div class="toast-stack" id="toast-stack" aria-live="polite" aria-atomic="true"></div>

</body>
</html>

