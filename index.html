<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>MED Test UNPID ‚Ä¢ Quiz Hub</title>

  <style>
    /* RESET & VARS */
    :root{
      /* Light Theme Defaults */
      --bg-body:#fbfbfd;
      --glass: rgba(255,255,255,0.68);
      --glass-border: rgba(255,255,255,0.50);
      --glass-shadow: 0 14px 40px rgba(0,0,0,0.06);

      --primary:#0071e3;
      --primary-2:#4facfe;
      --primary-grad: linear-gradient(135deg, var(--primary), var(--primary-2));

      --text-main:#1d1d1f;
      --text-sec:#86868b;
      --text-inv: #ffffff;

      --danger:#ff3b30;
      --success:#34c759;
      
      --card-bg: rgba(255,255,255,0.55);
      --input-bg: #f2f2f7;
      --input-bg-focus: #ffffff;

      --radius-l: 28px;
      --radius-m: 18px;
      --radius-s: 12px;

      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* DARK THEME OVERRIDES */
    [data-theme="dark"] {
      --bg-body: #000000;
      --glass: rgba(28, 28, 30, 0.75);
      --glass-border: rgba(255,255,255,0.12);
      --glass-shadow: 0 14px 40px rgba(0,0,0,0.3);

      --primary: #0a84ff;
      --primary-2: #5ac8fa;
      
      --text-main: #f5f5f7;
      --text-sec: #98989d;
      --text-inv: #000000;

      --card-bg: rgba(255,255,255,0.08);
      --input-bg: #1c1c1e;
      --input-bg-focus: #2c2c2e;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    html,body{height:100%;min-height:100dvh;width:100%;margin:0;padding:0;font-family:var(--font);color:var(--text-main);overflow:hidden;background:var(--bg-body);overscroll-behavior:none; transition: background 0.3s ease, color 0.3s ease;}

    /* Ambient background */
    .ambient-bg{
      position:absolute; inset:-50%; width:200%; height:200%;
      background:
        radial-gradient(circle at 50% 50%, rgba(0,113,227,0.15), transparent 40%),
        radial-gradient(circle at 20% 80%, rgba(52,199,89,0.12), transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(175,82,222,0.12), transparent 40%);
      animation: moveBg 20s infinite alternate ease-in-out;
      z-index:-1;
      pointer-events:none;
    }
    [data-theme="dark"] .ambient-bg { opacity: 0.6; }

    @keyframes moveBg{
      0%{transform:translate(0,0) scale(1)}
      100%{transform:translate(-5%,-5%) scale(1.05)}
    }

    /* Shell */
    .app-shell{
      display:flex;
      flex-direction:column;
      height:100%;
      max-width:1200px;
      margin:0 auto;
      position:relative;
    }

    /* Glass panels */
    .glass-panel{
      background:var(--glass);
      backdrop-filter:saturate(180%) blur(24px);
      -webkit-backdrop-filter:saturate(180%) blur(24px);
      border:1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      color: var(--text-main);
    }

    header{
      padding: calc(20px + env(safe-area-inset-top, 0px)) 24px 20px 24px;
      display:flex; align-items:center; justify-content:space-between;
      z-index:100;
    }
    .logo-area{display:flex; align-items:center; gap:12px;}
    .logo-icon{
      width:40px;height:40px;border-radius:12px;
      background: var(--primary-grad);
      color:white;font-weight:900;font-size:1.15rem;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 12px rgba(0,113,227,0.25);
    }
    .app-name{font-weight:800;font-size:1.08rem; letter-spacing:-0.02em;}
    .nav-actions{display:flex;gap:12px; align-items:center;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: var(--card-bg);
      border:1px solid var(--glass-border);
      color: var(--text-sec);
      font-weight:800;
      font-size:0.82rem;
    }

    .btn-icon{
      width:40px;height:40px;border-radius:50%;
      border:none;
      background:rgba(128,128,128,0.1);
      color:var(--text-main);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:transform .2s var(--ease), background .2s var(--ease);
      user-select:none;
      font-size:1.05rem;
    }
    .btn-icon:hover{background:rgba(128,128,128,0.2);transform:scale(1.05)}
    .btn-icon:active{transform:scale(0.97)}

    /* Views */
    .view-container{flex:1; position:relative; overflow:hidden;}
    .view{
      position:absolute; inset:0;
      padding:20px 24px 110px 24px;
      overflow-y:auto; overflow-x:hidden;
      opacity:0; pointer-events:none;
      transform: translateY(18px) scale(0.985);
      transition: opacity .42s var(--ease), transform .42s var(--ease);
      display:flex; flex-direction:column; gap:24px;
    }
    .view.active{
      opacity:1; pointer-events:auto;
      transform: translateY(0) scale(1);
      z-index:10;
    }

    /* Titles */
    .section-header{margin-bottom:2px;}
    .h2-title{font-size:2rem;font-weight:800;margin:0;letter-spacing:-0.02em; color: var(--text-main);}
    .h-sub{color:var(--text-sec);font-size:1rem;margin-top:6px;line-height:1.45;}

    /* Buttons */
    .btn-primary{
      width:100%;
      padding:16px;
      border-radius:999px;
      border:none;
      background: var(--text-main);
      color: var(--bg-body); 
      font-size:1rem;
      font-weight:800;
      cursor:pointer;
      transition:transform .2s var(--ease), box-shadow .2s var(--ease), opacity .2s var(--ease);
      user-select:none;
    }
    [data-theme="dark"] .btn-primary { color: #000; background: #fff; } /* Invertito per contrasto */
    
    .btn-primary.blue{background: var(--primary); color: white;}
    
    .btn-primary:hover{transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.14);}
    .btn-primary:active{transform: scale(0.985);}
    .btn-primary:disabled{opacity:.45; cursor:not-allowed; transform:none; box-shadow:none;}
    
    .btn-secondary{
      width:100%;
      padding:14px 16px;
      border-radius:999px;
      border:1px solid var(--glass-border);
      background: var(--card-bg);
      color: var(--text-main);
      font-weight:800;
      cursor:pointer;
      transition:transform .2s var(--ease), background .2s var(--ease);
    }
    .btn-secondary:hover{transform: translateY(-1px); background: rgba(128,128,128,0.15);}

    /* Inputs */
    .input-group{margin-bottom:14px;}
    .input-label{
      display:block; font-size:.82rem; font-weight:800;
      color: var(--text-sec); margin:0 0 8px 4px;
    }
    .input-field{
      width:100%;
      padding:16px;
      border-radius: var(--radius-m);
      border:1px solid transparent;
      background: var(--input-bg);
      color: var(--text-main);
      font-size:1rem;
      font-weight:650;
      font-family:inherit;
      transition:all .2s var(--ease);
    }
    .input-field:focus{
      background: var(--input-bg-focus);
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.14);
    }
    .inline-row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .inline-row .input-field{max-width:160px; text-align:center;}

    /* Course grid */
    .grid-courses{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap:20px;
    }
    .course-card{
      border-radius: var(--radius-l);
      padding:24px;
      cursor:pointer;
      transition: all .3s var(--ease);
      display:flex;
      flex-direction:column;
      min-height:220px;
      height:auto;
      justify-content:space-between;
      overflow:hidden;
      position:relative;
    }
    .course-card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(circle at 30% 20%, rgba(0,113,227,0.10), transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(175,82,222,0.08), transparent 60%);
      pointer-events:none;
    }
    .course-card > *{position:relative;}
    .course-card:hover{transform: translateY(-6px); box-shadow: 0 18px 50px rgba(0,0,0,0.08);}
    .course-icon{font-size:3rem; margin-bottom:10px;}
    .course-info h3{margin:0; font-size:1.45rem; font-weight:850; letter-spacing:-0.02em;}
    .course-info p{margin:8px 0 0 0; color: var(--text-sec); font-size:.95rem; line-height:1.4;}
    .course-stats{display:flex; gap:10px; margin-top:auto; flex-wrap:wrap; min-width:0;}
    .badge{
      display:inline-flex;
      align-items:center;
      font-size:0.78rem;
      font-weight:850;
      padding:7px 12px;
      border-radius:999px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-sec);
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.15;
      flex: 0 1 auto;
      min-width: 0;
    }

    /* Course view */
    .top-bar{display:flex; align-items:center; gap:12px; margin-bottom:4px;}
    .back-btn{font-weight:800;color: var(--text-sec); cursor:pointer; display:flex; align-items:center; gap:6px; font-size:.95rem; user-select:none;}
    .back-btn:hover{color: var(--primary);}

    .stats-row{display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
    @media (max-width: 720px){
      .stats-row{grid-template-columns:1fr;}
    }
    .stat-card{
      padding:20px; border-radius: var(--radius-m);
      display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
      position:relative; overflow:hidden;
    }
    .stat-val{font-size:2rem; font-weight:900; color: var(--text-main);}
    .stat-label{font-size:.78rem; font-weight:900; color: var(--text-sec); text-transform:uppercase; letter-spacing:.06em;}
    .stat-mini{margin-top:10px; color: var(--text-sec); font-weight:750; font-size:.92rem; line-height:1.35;}

    .panel{
      padding:24px;
      border-radius: var(--radius-l);
    }

    /* Module grid */
    .modules-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap:12px;
      margin-top:14px;
    }
    .module-item{
      padding:16px;
      border-radius: var(--radius-m);
      border:2px solid transparent;
      background: var(--card-bg);
      cursor:pointer;
      transition: all .2s var(--ease);
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      user-select:none;
      color: var(--text-main);
    }
    .module-item:hover{transform: translateY(-2px);}
    .module-item.selected{
      border-color: var(--primary);
      background: rgba(0,113,227,0.12);
    }
    .m-title{font-weight:850;font-size:.98rem;margin-bottom:6px;}
    .m-sub{font-size:.82rem;color: var(--text-sec);}

    /* Segmented controls */
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      background: rgba(128,128,128,0.1);
      color: var(--text-sec);
      font-weight:850;
      cursor:pointer;
      transition: all .2s var(--ease);
      user-select:none;
    }
    .seg button:hover{background: rgba(128,128,128,0.2);}
    .seg button.active{
      background: rgba(0,113,227,0.15);
      color: var(--primary);
    }

    /* Charts */
    .chart-wrap{
      margin-top:14px;
      border-radius: var(--radius-l);
      padding:14px;
      background: var(--card-bg);
      border:1px solid var(--glass-border);
    }
    canvas{width:100%; display:block;}
    .module-list{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      max-height:220px;
      overflow:auto;
      padding-right:2px;
    }
    @media (max-width: 720px){
      .module-list{grid-template-columns:1fr;}
    }
    .module-row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius: var(--radius-m);
      background: var(--card-bg);
      border:1px solid rgba(0,0,0,0.06);
      font-weight:850;
      color: var(--text-main);
    }
    .module-row .val{color: var(--primary);}

    /* Quiz view */
    .quiz-progress{height:6px;background: rgba(128,128,128,0.15); border-radius:999px; overflow:hidden; margin:8px 0 18px 0;}
    .quiz-bar{height:100%; background: var(--primary); width:0%; transition: width .35s ease;}

    .question-card{
      padding:32px 24px;
      text-align:center;
      border-radius: var(--radius-l);
      min-height:200px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:18px;
    }
    .q-text{font-size:1.35rem;font-weight:850;line-height:1.4; color: var(--text-main);}
    .q-chip{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(0,113,227,0.10);
      border:1px solid rgba(0,113,227,0.12);
      color: var(--primary);
      font-weight:900;
      font-size:.82rem;
    }

    .options-stack{display:flex; flex-direction:column; gap:12px; padding-bottom:120px;}
    .opt-btn{
      width:100%;
      padding:20px 24px;
      text-align:left;
      border-radius: var(--radius-m);
      border:1px solid var(--glass-border);
      background: var(--card-bg);
      color: var(--text-main);
      font-size:1rem;
      font-weight:750;
      cursor:pointer;
      transition: all .2s var(--ease);
      box-shadow: 0 6px 16px rgba(0,0,0,0.03);
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .opt-btn:active{transform: scale(0.985);}
    .opt-btn.correct{background: rgba(52,199,89,0.15); border-color: rgba(52,199,89,0.55); color: var(--success);}
    .opt-btn.wrong{background: rgba(255,59,48,0.15); border-color: rgba(255,59,48,0.55); color: var(--danger);}
    .opt-btn:disabled{cursor:default; opacity:1;}

    /* Floating bars */
    .float-bar{
      position:fixed;
      bottom: calc(24px + env(safe-area-inset-bottom));
      left:50%;
      transform: translateX(-50%);
      width: min(92%, 640px);
      padding:10px;
      border-radius:999px;
      display:flex;
      gap:10px;
      z-index:150;
      opacity:0;
      pointer-events:none;
      transition: all .3s var(--ease);
    }
    .float-bar.visible{opacity:1; pointer-events:auto; bottom: calc(32px + env(safe-area-inset-bottom));}
    .float-mini{
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.06);
      background: var(--card-bg);
      color: var(--text-sec);
      font-weight:850;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .float-mini strong{color: var(--text-main);}
    .float-btn{
      flex:1;
      padding:14px 16px;
      border-radius:999px;
      border:none;
      background: var(--primary);
      color:white;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 14px 34px rgba(0,113,227,0.25);
      transition: transform .2s var(--ease), opacity .2s var(--ease);
    }
    .float-btn:active{transform: scale(0.985);}
    .float-btn:disabled{opacity:.45; cursor:not-allowed; transform:none;}
    .float-btn.secondary{
      background: rgba(128,128,128,0.15);
      color: var(--text-main);
      box-shadow:none;
    }

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.36);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index:200;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal-overlay.active{display:flex; animation: fadeIn .18s ease;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{
      width:min(520px, 100%);
      border-radius: 28px;
      padding: 22px;
      position:relative;
      background: var(--glass);
      color: var(--text-main);
      box-shadow: var(--glass-shadow);
      border: 1px solid var(--glass-border);
    }
    .modal h3{margin:0 0 6px 0; font-weight:900;}
    .modal p{margin:0 0 14px 0; color: var(--text-sec); line-height:1.45;}
    .modal .x{
      position:absolute; top:14px; right:14px;
      width:40px;height:40px;border-radius:50%;
      border:none;background: rgba(128,128,128,0.1);
      cursor:pointer; color: var(--text-main);
    }
    .error{
      margin-top:10px;
      padding:12px 14px;
      border-radius: var(--radius-m);
      background: rgba(255,59,48,0.10);
      border: 1px solid rgba(255,59,48,0.20);
      color: #ea3a31;
      font-weight:800;
      display:none;
    }
    [data-theme="dark"] .error { color: #ff5e55; }

    /* Search */
    .search-card.selected{
      outline: 2px solid rgba(0,113,227,0.55);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.12);
    }

    /* Helpers */
    .hidden{display:none !important;}
    .pill-link{
      border:none;
      background:transparent;
      color: var(--primary);
      font-weight:850;
      cursor:pointer;
      padding:0;
      font-size: 0.9rem;
    }
    .divider{height:1px; background: rgba(128,128,128,0.15); margin:16px 0;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  
    /* Toasts */
    .toast-stack{
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
      width: min(92vw, 460px);
    }
    .toast{
      pointer-events: auto;
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding: 12px 14px;
      border-radius: 18px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      box-shadow: 0 16px 46px rgba(0,0,0,0.12);
      -webkit-backdrop-filter: blur(18px);
      backdrop-filter: blur(18px);
      overflow: hidden;
      position: relative;
      color: var(--text-main);
    }
    .toast::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 3px;
      background: var(--primary);
    }
    .toast.success::before{ background: var(--success); }
    .toast.warn::before{ background: #ff9f0a; }
    .toast.danger::before{ background: var(--danger); }
    .toast h4{ margin:0; font-size: 13px; letter-spacing: .2px; }
    .toast p{ margin:3px 0 0; color: var(--text-sec); font-size: 12.5px; line-height: 1.35; }
    .toast .t-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .toast .t-btn{
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 750;
      font-size: 12px;
      border: 1px solid var(--glass-border);
      background: var(--card-bg);
      cursor: pointer;
      color: var(--text-main);
    }
    .toast .t-btn.primary{
      background: var(--primary);
      border-color: transparent;
      color: white;
    }
    .toast .t-x{
      margin-left:auto;
      border:none;
      background:transparent;
      cursor:pointer;
      opacity:.6;
      font-size: 16px;
      line-height: 1;
      padding: 2px 6px;
      color: var(--text-main);
    }
    .toast .t-x:hover{ opacity: 1; }

    /* Auth Success Notice */
    .notice{
      padding: 14px;
      border-radius: 18px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      box-shadow: 0 16px 46px rgba(0,0,0,0.06);
    }
    .notice-title{ margin:0; font-size: 15px; font-weight: 850; }
    .notice-sub{ margin:6px 0 0; color: var(--text-sec); font-size: 13px; line-height: 1.35; }
  </style>
</head>

<body>
  <div class="ambient-bg"></div>

  <div class="app-shell">
    <header>
      <div class="logo-area">
        <div class="logo-icon">M</div>
        <div>
          <div class="app-name">MED Test UNPID</div>
          <div style="color:var(--text-sec);font-weight:750;font-size:.9rem;margin-top:2px;" id="crumb">Corsi</div>
        </div>
      </div>

      <div class="nav-actions">
        <button class="btn-icon" id="theme-toggle" title="Cambia tema" onclick="toggleTheme()">‚òÄÔ∏é</button>
        <button class="btn-icon" title="Home" aria-label="Home" onclick="goHome()">‚åÇ</button>
      </div>
    </header>

    <div class="view-container">
      <section id="view-dashboard" class="view active">
        <div class="section-header">
          <h2 class="h2-title">Corsi disponibili</h2>
          <p class="h-sub">Scegli un corso. Statistiche, errori e ripasso si sbloccano col login.</p>
        </div>

        <div class="glass-panel panel" style="margin-bottom:18px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900; color:var(--text-main);">Account</h3>
              <p class="h-sub" style="margin-top:6px;" id="user-display-dash">Ospite (login opzionale)</p>
            </div>
            <span class="chip" id="chip-auth">üîí Ospite</span>
          </div>

          <div id="dash-loggedout">
            <div style="height:10px"></div>
            <div class="inline-row">
              <button class="btn-primary blue" style="max-width:220px;" onclick="openAuth('login')">Accedi</button>
              <button class="btn-secondary" style="max-width:220px;" onclick="openAuth('signup')">Registrati</button>
            </div>
            <p class="h-sub" style="margin-top:12px;">Con il login sblocchi grafici, errori e ripasso (separati per corso).</p>
          </div>

          <div id="dash-loggedin" class="hidden">
            <div style="height:10px"></div>
            <div class="inline-row">
              <button class="btn-secondary" style="max-width:220px;" onclick="openAuth('login')">Gestisci account</button>
              <button class="btn-secondary" style="max-width:220px;" onclick="switchAccount()">Cambia account</button>
              <button class="btn-secondary" style="max-width:220px; border-color: rgba(255,59,48,0.35);" onclick="logout()">Esci</button>
            </div>
          </div>
        </div>
        <div class="grid-courses" id="courses-grid"></div>
      </section>


      <section id="view-auth" class="view">
        <div class="top-bar">
          <div class="back-btn" onclick="navBackFromAuth()">‚Üê Indietro</div>
        </div>

        <div class="section-header">
          <h2 class="h2-title">Account</h2>
          <p class="h-sub">Login email + password per salvare statistiche, errori e ripasso.</p>
        </div>

        <div class="glass-panel panel">
          <h3 id="auth-title" style="margin:0; color:var(--text-main);">Accedi</h3>
          <p id="auth-sub" class="h-sub" style="margin-top:8px;">Email + password. Statistiche separate per corso.</p>

          <div class="divider"></div>

          <p id="user-display" style="margin:0; font-weight:850; color:var(--text-main);">Ospite</p>
          <div style="height:10px"></div>

          <div class="error" id="auth-error"></div>

          <div id="auth-success" class="notice hidden" style="margin-top:12px;">
            <p class="notice-title" id="auth-success-title" style="color:var(--text-main);">Operazione completata</p>
            <p class="notice-sub" id="auth-success-sub">‚Äî</p>
            <div class="divider" style="margin:12px 0;"></div>
            <div class="inline-row" style="flex-wrap:wrap;">
              <button class="btn-primary blue" id="auth-success-primary" onclick="authSuccessPrimary()">Vai ai corsi</button>
              <button class="btn-secondary" id="auth-success-secondary" onclick="authSuccessSecondary()">Accedi</button>
            </div>
          </div>


          <div id="profile-loggedout">
            <div id="auth-login">
              <div class="input-group">
                <label class="input-label">Email</label>
                <input class="input-field" id="loginEmail" type="email" autocomplete="email" placeholder="nome@scuola.it" />
              </div>
              <div class="input-group">
                <label class="input-label">Password</label>
                <input class="input-field" id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                <div style="text-align:right; margin-top:6px;">
                  <button class="pill-link" style="font-size:0.8rem;" onclick="openAuth('reset')">Password dimenticata?</button>
                </div>
              </div>
              <button type="button" class="btn-primary blue" id="btn-login" onclick="login()">Accedi</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary hidden" id="btn-resend" onclick="resendSignupEmail()">Reinvia email di conferma</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary" onclick="openAuth('signup')">Non hai un account? Registrati</button>
            </div>

            <div id="auth-signup" class="hidden">
              <div class="input-group">
                <label class="input-label">Username</label>
                <input class="input-field" id="signupUser" type="text" autocomplete="nickname" placeholder="Es: Ludovico" />
              </div>
              <div class="input-group">
                <label class="input-label">Email</label>
                <input class="input-field" id="signupEmail" type="email" autocomplete="email" placeholder="nome@scuola.it" />
              </div>
              <div class="input-group">
                <label class="input-label">Password (min 8)</label>
                <input class="input-field" id="signupPass" type="password" autocomplete="new-password" placeholder="Min 8 caratteri" />
              </div>
              <button type="button" class="btn-primary blue" id="btn-signup" onclick="signup()">Crea account</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary hidden" id="btn-resend-signup" onclick="resendSignupEmail(true)">Reinvia email di conferma</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary" onclick="openAuth('login')">Hai gi√† un account? Accedi</button>
            </div>

            <div id="auth-reset" class="hidden">
              <p class="h-sub" style="margin-bottom:12px;">Inserisci la tua email. Ti invieremo un link per reimpostare la password.</p>
              <div class="input-group">
                <label class="input-label">Email</label>
                <input class="input-field" id="resetEmail" type="email" autocomplete="email" placeholder="nome@scuola.it" />
              </div>
              <button type="button" class="btn-primary blue" id="btn-reset-req" onclick="requestPasswordReset()">Invia link di recupero</button>
              <div style="height:10px"></div>
              <button type="button" class="btn-secondary" onclick="openAuth('login')">Annulla</button>
            </div>

            <div id="auth-update" class="hidden">
              <p class="h-sub" style="margin-bottom:12px;">Inserisci la tua nuova password per completare il recupero.</p>
              <div class="input-group">
                <label class="input-label">Nuova Password</label>
                <input class="input-field" id="updatePass" type="password" autocomplete="new-password" placeholder="Min 8 caratteri" />
              </div>
              <button type="button" class="btn-primary blue" id="btn-update-pass" onclick="updateUserPassword()">Salva nuova password</button>
            </div>
          </div>

          <div id="profile-loggedin" class="hidden">
            <p class="h-sub">Sei loggato. Le statistiche vengono salvate automaticamente.</p>
            <div style="height:12px"></div>
            <div class="inline-row">
              <button class="btn-primary" style="max-width:240px;" onclick="navTo('dashboard')">Vai ai corsi</button>
              <button class="btn-secondary" style="max-width:240px;" onclick="switchAccount()">Cambia account</button>
              <button class="btn-secondary" style="max-width:200px; border-color: rgba(255,59,48,0.35);" onclick="logout()">Esci</button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-course" class="view">
        <div class="top-bar">
          <div class="back-btn" onclick="navTo('dashboard')">‚Üê Corsi</div>
        </div>

        <div class="section-header">
          <h2 class="h2-title" id="course-title">Corso</h2>
          <p class="h-sub" id="course-desc">‚Äî</p>
        </div>

        <div class="stats-row">
          <div class="glass-panel stat-card">
            <div class="stat-val" id="stat-avg">‚Äî%</div>
            <div class="stat-label">Media corso</div>
            <div class="stat-mini" id="stat-avg-sub">Accedi per vedere la tua media in questo corso.</div>
          </div>
          <div class="glass-panel stat-card">
            <div class="stat-val" id="stat-done">‚Äî</div>
            <div class="stat-label">Quiz svolti</div>
            <div class="stat-mini" id="stat-done-sub">Accedi per vedere la cronologia dei quiz.</div>
          </div>
        </div>

        <div class="glass-panel panel" id="panel-progress">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:14px; flex-wrap:wrap;">
            <h3 style="margin:0; font-weight:900; color:var(--text-main);">Andamento</h3>
            <div class="seg">
              <button id="btn-line" class="active" onclick="setProgressType('line')">Linea</button>
              <button id="btn-bar" onclick="setProgressType('bar')">Istogramma</button>
            </div>
          </div>
          <p class="h-sub" style="margin-top:8px;">Ultimi 30 quiz in questo corso.</p>
          <div class="chart-wrap">
            <canvas id="progressChart" height="130"></canvas>
          </div>
          <div class="divider"></div>
          <div class="inline-row">
            <button class="btn-secondary" style="max-width:220px;" id="btn-wrong" onclick="openQuizSettings('wrong')">‚ö†Ô∏è Quiz errori</button>
            <button class="btn-secondary" style="max-width:240px;" id="btn-old" onclick="openQuizSettings('old')">üï∞Ô∏è Ripasso vecchie</button>
            <div style="color:var(--text-sec);font-weight:800;">
              Errori: <strong id="wrong-count" style="color:var(--text-main)">‚Äî</strong> ‚Ä¢ Vecchia: <strong id="oldest-label" style="color:var(--text-main)">‚Äî</strong>
            </div>
          </div>
          <div class="error" id="locked-hint">
            Questa sezione richiede login (email+password).
            <div style="height:10px"></div>
            <button class="btn-primary blue" style="max-width:220px;" onclick="openAuth('login')">Accedi</button>
          </div>
        </div>

        <div class="glass-panel panel hidden" id="panel-modules">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:14px; flex-wrap:wrap;">
            <h3 style="margin:0; font-weight:900; color:var(--text-main);">Accuratezza per modulo</h3>
            <span class="chip">calcolata da <span class="mono">question_progress</span></span>
          </div>
          <div class="chart-wrap">
            <canvas id="moduleChart" height="180"></canvas>
          </div>
          <div class="module-list" id="moduleList"></div>
        </div>

        <div class="glass-panel panel">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900; color:var(--text-main);">Ricerca nel corso</h3>
              <p class="h-sub">Cerca parole chiave e costruisci un quiz dai risultati.</p>
            </div>
            <button class="btn-secondary" style="max-width:160px;" id="btn-search-start" onclick="openQuizSettings('search')" disabled>Avvia</button>
          </div>
          <div style="height:10px"></div>
          <input class="input-field" id="search" placeholder="Es: talamo, cornea, Murphy..." oninput="onSearch()" />
          <div style="margin-top:14px; display:flex; flex-direction:column; gap:12px; max-height:260px; overflow:auto;" id="searchResults"></div>
        </div>

        <div class="glass-panel panel">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900; color:var(--text-main);">Moduli</h3>
              <p class="h-sub">Seleziona i moduli, poi scegli quante domande quando avvii il quiz.</p>
            </div>
            <button class="pill-link" onclick="selectAllModules()">Seleziona tutti</button>
          </div>

          <div class="modules-grid" id="modules-list"></div>
          <div style="height:12px"></div>

          <div class="inline-row">
            <button class="btn-secondary" style="max-width:220px;" onclick="clearModules()">Deseleziona</button>
            <button class="btn-secondary" style="max-width:260px;" onclick="openQuizSettings('course_exam')">üéì Simulazione corso</button>
          </div>
        </div>

        <div style="height:80px;"></div>
      </section>

      <section id="view-quiz" class="view">
        <div class="top-bar" style="justify-content:space-between;">
          <div class="back-btn" onclick="quitQuiz()">‚úï Esci</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="q-chip" id="q-chip">‚Äî</span>
            <div style="font-weight:800; color:var(--text-sec);" id="q-counter">1 / 10</div>
          </div>
        </div>

        <div class="quiz-progress">
          <div class="quiz-bar" id="progress-bar"></div>
        </div>

        <div class="glass-panel question-card">
          <div class="q-text" id="q-text">Caricamento domanda...</div>
        </div>

        <div class="options-stack" id="options-container"></div>
      </section>

      <section id="view-results" class="view" style="text-align:center; justify-content:center;">
        <div class="glass-panel" style="padding:40px; border-radius:32px; display:inline-flex; flex-direction:column; align-items:center; max-width:420px; margin:0 auto;">
          <div style="width:120px; height:120px; border-radius:50%; background:var(--input-bg); display:flex; align-items:center; justify-content:center; margin-bottom:20px; box-shadow:inset 0 4px 12px rgba(0,0,0,0.05);">
            <div style="font-size:2.5rem; font-weight:900; color:var(--primary);" id="final-score">80%</div>
          </div>
          <h2 class="h2-title" style="margin:0;">Sessione completata</h2>
          <p class="h-sub" id="final-msg" style="margin:10px 0 26px 0;">Ottimo lavoro.</p>

          <div style="display:flex; gap:10px; width:100%; flex-wrap:wrap;">
            <button class="btn-primary blue" style="flex:1; min-width:180px;" onclick="backToCourse()">Torna al corso</button>
            <button class="btn-secondary" style="flex:1; min-width:180px;" onclick="navTo('dashboard')">Corsi</button>
          </div>
        </div>
      </section>
    </div>

    <div class="glass-panel float-bar" id="course-actions">
      <div class="float-mini">Selezionati: <strong id="sel-count">0</strong></div>
      <button class="float-btn" id="btn-start" disabled onclick="openQuizSettings('modules')">Avvia Quiz</button>
      <button class="float-btn secondary" onclick="navTo('dashboard')">Chiudi</button>
    </div>

    <div class="glass-panel float-bar" id="quiz-actions" style="width:min(92%, 260px);">
      <button class="float-btn" id="btn-next" onclick="nextQuestion()">Salta ‚Üí</button>
    </div>
  </div>

  <div class="modal-overlay" id="settings-modal" onclick="if(event.target===this) closeSettings()">
    <div class="glass-panel modal" role="dialog" aria-modal="true">
      <button class="x" aria-label="Chiudi" onclick="closeSettings()">‚úï</button>
      <h3>Impostazioni quiz</h3>
      <p id="settings-desc">Scegli quante domande vuoi fare.</p>

      <div class="input-group">
        <label class="input-label">Numero domande (0 = tutte)</label>
        <div class="inline-row">
          <input class="input-field" id="settings-limit" type="number" min="0" value="20" />
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(10)">10</button>
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(20)">20</button>
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(0)">Tutte</button>
        </div>
      </div>

      <div class="divider"></div>

      <div id="settings-old-wrap" class="hidden">
        <div class="input-group">
          <label class="input-label">Ripasso: domande non viste da almeno (giorni)</label>
          <div class="inline-row">
            <input class="input-field" id="settings-old-days" type="number" min="0" value="14" />
            <button class="btn-secondary" style="max-width:160px;" onclick="setOldDays(3)">3</button>
            <button class="btn-secondary" style="max-width:160px;" onclick="setOldDays(7)">7</button>
            <button class="btn-secondary" style="max-width:160px;" onclick="setOldDays(14)">14</button>
          </div>
          <label style="display:flex; gap:10px; align-items:center; margin-top:10px; font-weight:750; color:var(--text-sec);">
            <input type="checkbox" id="settings-old-unseen" checked />
            Include anche le domande mai viste
          </label>
        </div>
        <div class="divider"></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn-secondary" style="flex:1; min-width:180px;" onclick="closeSettings()">Annulla</button>
        <button class="btn-primary blue" style="flex:1; min-width:180px;" id="settings-start" onclick="startFromSettings()">Avvia</button>
      </div>
      <div class="error" id="settings-error"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./neuro_questions.js"></script>
  <script src="./splanco.js"></script>
  <script>
    /***********************************************************************
     * CONFIGURAZIONE
     **********************************************************************/
    const SUPABASE_URL = "https://haohnwguytakaqqqmflj.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhhb2hud2d1eXRha2FxcXFtZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzU0NDUsImV4cCI6MjA4MjQxMTQ0NX0.bsy2ClUJLoFv7hX5ypnzVAXtUzUTUnkX5sVpSWUTjaw";

    function fetchWithTimeout(ms=15000){
      return (url, options={}) => {
        const controller = new AbortController();
        const id = setTimeout(()=>controller.abort(), ms);
        const opts = { ...options, signal: controller.signal };
        return fetch(url, opts).finally(()=> clearTimeout(id));
      };
    }

    const supa = (SUPABASE_URL.includes("YOUR_PROJECT"))
      ? null
      : supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        global: { fetch: fetchWithTimeout(15000) },
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true,
          flowType: "pkce"
        }
      });

    /***********************************************************************
     * DATI QUIZ
     **********************************************************************/
    const QUIZ_PACKS = {
      neuro: {
        id: "neuro",
        title: "Neuroanatomia",
        desc: "Tronco encefalico, midollo, vie e concetti base.",
        icon: "üß†",
        modules: window.NEURO_MODULES || {}
      },
      splanco: {
        id: "splanco",
        title: "Splancologia",
        desc: "Apparati viscerali: respiratorio, digerente, urinario...",
        icon: "ü´Å",
        modules: window.SPLANCO_MODULES || {}
      },
      semeiotica: {
        id: "semeiotica",
        title: "Semeiotica",
        desc: "Addome e torace: segni clinici fondamentali.",
        icon: "ü©∫",
        modules: {
          "Addome": [
            { q: "Il segno di Murphy √® positivo quando:", a: ["Dolore e arresto inspiratorio palpazione ipocondrio dx", "Dolore fossa iliaca dx", "Ittero", "Vomito"], cat:"Addome" },
            { q: "La peritonite d√† tipicamente:", a: ["Addome 'a tavola' e dolorabilit√†", "Murmullo ridotto", "Edema", "Cianosi"], cat:"Addome" }
          ],
          "Torace": [
             { q: "Il fremito vocale tattile diminuisce in:", a: ["Versamento pleurico", "Consolidamento", "Fibrosi", "Asma"], cat:"Torace" }
          ]
        }
      }
    };

    /***********************************************************************
     * STATO
     **********************************************************************/
    const state = {
      isLogged: false,
      currentUser: null,
      profile: null,
      currentCourseId: null,
      selectedModules: new Set(),
      searchHits: [],
      searchLastQuery: "",
      searchLastResultIds: [],
      mode: null,
      quizQuestions: [],
      quizIndex: 0,
      quizCorrect: 0,
      quizAnswered: false,
      pendingMode: null,
      pendingAttemptSave: null,
      pendingAttemptCourseId: null
    };

    const QMAP = {};
    buildQuestionMaps();

    function buildQuestionMaps(){
      for (const cId of Object.keys(QUIZ_PACKS)){
        QMAP[cId] = {};
        const pack = QUIZ_PACKS[cId];
        for (const mod of Object.keys(pack.modules)){
          pack.modules[mod].forEach((qq) => {
            const qid = makeQid(cId, mod, qq.q);
            QMAP[cId][qid] = { module: mod, cat: qq.cat || mod, q: qq.q, a: qq.a, correct: qq.correct };
          });
        }
      }
    }

    /***********************************************************************
     * UI References
     **********************************************************************/
    const crumbEl = document.getElementById("crumb");
    const chipAuth = document.getElementById("chip-auth");
    const themeBtn = document.getElementById("theme-toggle");

    // views
    const vDashboard = document.getElementById("view-dashboard");
    const vCourse = document.getElementById("view-course");
    const vQuiz = document.getElementById("view-quiz");
    const vResults = document.getElementById("view-results");
    const vAuth = document.getElementById("view-auth");

    // elements
    const coursesGrid = document.getElementById("courses-grid");
    const courseTitle = document.getElementById("course-title");
    const courseDesc = document.getElementById("course-desc");
    const modulesList = document.getElementById("modules-list");
    const statAvg = document.getElementById("stat-avg");
    const statDone = document.getElementById("stat-done");
    const lockedHint = document.getElementById("locked-hint");
    const btnWrong = document.getElementById("btn-wrong");
    const btnOld = document.getElementById("btn-old");
    const wrongCountEl = document.getElementById("wrong-count");
    const oldestLabelEl = document.getElementById("oldest-label");
    const searchEl = document.getElementById("search");
    const searchResultsEl = document.getElementById("searchResults");
    const btnSearchStart = document.getElementById("btn-search-start");
    const courseActions = document.getElementById("course-actions");
    const selCountEl = document.getElementById("sel-count");
    const btnStart = document.getElementById("btn-start");
    const quizActions = document.getElementById("quiz-actions");
    const btnNext = document.getElementById("btn-next");
    const qChip = document.getElementById("q-chip");
    const qCounter = document.getElementById("q-counter");
    const progressBar = document.getElementById("progress-bar");
    const qText = document.getElementById("q-text");
    const optionsContainer = document.getElementById("options-container");
    const finalScore = document.getElementById("final-score");
    const finalMsg = document.getElementById("final-msg");

    // Auth UI
    const authTitle = document.getElementById("auth-title");
    const authSub = document.getElementById("auth-sub");
    const authError = document.getElementById("auth-error");
    const authLogin = document.getElementById("auth-login");
    const authSignup = document.getElementById("auth-signup");
    const authReset = document.getElementById("auth-reset");
    const authUpdate = document.getElementById("auth-update");
    const userDisplay = document.getElementById("user-display");
    const profileLoggedOut = document.getElementById("profile-loggedout");
    const profileLoggedIn = document.getElementById("profile-loggedin");

    // Settings
    const settingsModal = document.getElementById("settings-modal");
    const settingsLimit = document.getElementById("settings-limit");
    const settingsError = document.getElementById("settings-error");
    const settingsDesc = document.getElementById("settings-desc");

    /***********************************************************************
     * INIT
     **********************************************************************/
    // Load theme preference
    const storedTheme = localStorage.getItem("theme");
    if (storedTheme) {
      document.documentElement.setAttribute("data-theme", storedTheme);
      if(storedTheme === 'dark') themeBtn.textContent = "‚òæ";
    }

    renderCourses();
    refreshSelectionBar();
    wireAuthEnterKeys();
    initChartObservers();

    if (!supa){
      console.warn("Supabase non configurato.");
      setAuthUI(null);
    } else {
      initAuth();
    }

    window.addEventListener("resize", () => {
      try{ queueChartRedraw(); }catch(e){}
    });

    function toggleTheme(){
      const current = document.documentElement.getAttribute("data-theme");
      const target = current === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", target);
      localStorage.setItem("theme", target);
      themeBtn.textContent = target === "dark" ? "‚òæ" : "‚òÄÔ∏é";
      queueChartRedraw();
    }

    /***********************************************************************
     * NAVIGAZIONE
     **********************************************************************/
    function navTo(viewId){
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      const target = document.getElementById("view-" + viewId);
      if(target) {
        target.classList.add("active");
        if(viewId==="dashboard" || viewId==="auth") window.scrollTo(0,0);
      }
      
      courseActions.classList.remove("visible");
      try{ quizActions.classList.remove("visible"); }catch(e){}

      if (viewId === "course"){
        courseActions.classList.add("visible");
        queueChartRedraw();
      }
      if (viewId === "quiz") {
        try{ quizActions.classList.add("visible"); }catch(e){}
      }
    }

    function goHome(){
      if (vQuiz.classList.contains("active") && !confirm("Vuoi uscire dal quiz?")) return;
      state.currentCourseId = null;
      navTo("dashboard");
    }

    function backToCourse(){
      if (!state.currentCourseId){ goHome(); return; }
      navTo("course");
      refreshCourseDashboard();
    }

    /***********************************************************************
     * LOGICA CORSI E SELEZIONE
     **********************************************************************/
    function renderCourses(){
      coursesGrid.innerHTML = "";
      Object.values(QUIZ_PACKS).forEach(c => {
        const qCount = Object.values(c.modules).reduce((acc, a)=> acc + a.length, 0);
        const mCount = Object.keys(c.modules).length;
        const card = document.createElement("div");
        card.className = "glass-panel course-card";
        card.onclick = () => openCourse(c.id);
        card.innerHTML = `
          <div><div class="course-icon">${c.icon}</div>
          <div class="course-info"><h3>${escapeHtml(c.title)}</h3><p>${escapeHtml(c.desc)}</p></div></div>
          <div class="course-stats"><span class="badge">${mCount} Moduli</span><span class="badge">${qCount} Domande</span></div>
        `;
        coursesGrid.appendChild(card);
      });
    }

    function openCourse(courseId){
      state.currentCourseId = courseId;
      state.selectedModules.clear();
      state.searchHits = [];
      
      const c = QUIZ_PACKS[courseId];
      crumbEl.textContent = `Corsi ‚Ä¢ ${c.title}`;
      courseTitle.textContent = c.title;
      courseDesc.textContent = c.desc;
      
      renderModulesSelection();
      refreshSelectionBar();
      navTo("course");
      refreshCourseDashboard();
    }

    function renderModulesSelection(){
      modulesList.innerHTML = "";
      const course = QUIZ_PACKS[state.currentCourseId];
      Object.keys(course.modules).forEach(m => {
        const item = document.createElement("div");
        item.className = "module-item";
        item.onclick = () => {
          if(state.selectedModules.has(m)) { state.selectedModules.delete(m); item.classList.remove("selected"); }
          else { state.selectedModules.add(m); item.classList.add("selected"); }
          refreshSelectionBar();
        };
        item.innerHTML = `<div class="m-title">${escapeHtml(m)}</div><div class="m-sub">${course.modules[m].length} domande</div>`;
        modulesList.appendChild(item);
      });
    }

    function refreshSelectionBar(){
      let count = 0;
      if(state.currentCourseId) {
        state.selectedModules.forEach(m => count += QUIZ_PACKS[state.currentCourseId].modules[m].length);
      }
      selCountEl.textContent = count;
      btnStart.disabled = state.selectedModules.size === 0;
    }

    function selectAllModules(){
      const course = QUIZ_PACKS[state.currentCourseId];
      state.selectedModules = new Set(Object.keys(course.modules));
      renderModulesSelection();
      document.querySelectorAll(".module-item").forEach(e=>e.classList.add("selected"));
      refreshSelectionBar();
    }
    function clearModules(){
      state.selectedModules.clear();
      renderModulesSelection();
      refreshSelectionBar();
    }

    /***********************************************************************
     * RICERCA
     **********************************************************************/
    function onSearch(){
      const q = (searchEl.value || "").trim().toLowerCase();
      if (!q || q.length < 2) {
        searchResultsEl.innerHTML = "";
        btnSearchStart.disabled = true;
        state.searchHits = [];
        return;
      }
      const map = QMAP[state.currentCourseId] || {};
      const hits = Object.entries(map)
        .filter(([_, obj]) => 
          obj.q.toLowerCase().includes(q) || obj.cat.toLowerCase().includes(q)
        ).slice(0, 50);

      state.searchLastResultIds = hits.map(h => h[0]);
      searchResultsEl.innerHTML = "";
      
      hits.forEach(([qid, h]) => {
        const d = document.createElement("div");
        d.className = "glass-panel search-card";
        d.style.cssText = "border-radius:20px; padding:14px; cursor:pointer;";
        d.innerHTML = `<div style="font-weight:850; color:var(--text-main);">${escapeHtml(trim(h.q,80))}</div><div style="font-size:0.8rem; color:var(--text-sec); margin-top:4px;">${h.module}</div>`;
        d.onclick = () => {
          if(state.searchHits.includes(qid)){ state.searchHits = state.searchHits.filter(x=>x!==qid); d.classList.remove("selected"); }
          else { state.searchHits.push(qid); d.classList.add("selected"); }
          btnSearchStart.disabled = state.searchHits.length === 0;
          btnSearchStart.textContent = `Avvia (${state.searchHits.length})`;
        };
        searchResultsEl.appendChild(d);
      });
    }

    /***********************************************************************
     * DASHBOARD CORSO (Statistiche)
     **********************************************************************/
    let __progressPoints = [];
    async function refreshCourseDashboard(){
      lockedHint.style.display = "none";
      btnWrong.disabled = true; btnOld.disabled = true;
      wrongCountEl.textContent = "‚Äî"; oldestLabelEl.textContent = "‚Äî";
      
      if (!state.isLogged || !supa){
        lockedHint.style.display = "block";
        return;
      }

      // 1. Fetch Attempts
      const { data: att } = await supa.from("quiz_attempts")
        .select("percent, created_at")
        .eq("user_id", state.currentUser.id).eq("course_id", state.currentCourseId)
        .order("created_at", {ascending:true}).limit(30);
      
      __progressPoints = att || [];
      drawProgressChart(__progressPoints);
      
      const avg = __progressPoints.length ? Math.round(__progressPoints.reduce((a,b)=>a+b.percent,0)/__progressPoints.length) : 0;
      statAvg.textContent = __progressPoints.length ? avg + "%" : "‚Äî";
      statDone.textContent = __progressPoints.length;

      // 2. Fetch Questions (Errori e Vecchie)
      const { data: qp } = await supa.from("question_progress")
        .select("qid, wrong, last_seen, attempts, correct, module")
        .eq("user_id", state.currentUser.id).eq("course_id", state.currentCourseId);
      
      const rows = qp || [];
      const errs = rows.filter(r => r.wrong > 0);
      wrongCountEl.textContent = errs.length;
      btnWrong.disabled = errs.length === 0;

      // Trova la pi√π vecchia
      let oldest = null;
      rows.forEach(r => {
         if(r.last_seen){
           const t = new Date(r.last_seen).getTime();
           if(!oldest || t < oldest.t) oldest = { t, qid: r.qid };
         }
      });
      if(oldest && QMAP[state.currentCourseId][oldest.qid]){
        oldestLabelEl.textContent = trim(QMAP[state.currentCourseId][oldest.qid].q, 40);
        btnOld.disabled = false;
      } else {
        oldestLabelEl.textContent = "‚Äî";
        btnOld.disabled = true; 
      }

      // Chart Moduli
      const modAgg = {};
      rows.forEach(r => {
        if(!modAgg[r.module]) modAgg[r.module] = {c:0, a:0};
        modAgg[r.module].c += r.correct;
        modAgg[r.module].a += r.attempts;
      });
      const labels = Object.keys(modAgg).sort();
      const vals = labels.map(l => Math.round((modAgg[l].c/modAgg[l].a)*100));
      if(labels.length) {
        document.getElementById("panel-modules").classList.remove("hidden");
        drawModuleChart(labels, vals);
      }
    }

    /***********************************************************************
     * IMPOSTAZIONI E AVVIO QUIZ (Fix Logic)
     **********************************************************************/
    function openQuizSettings(mode){
      if ((mode==="wrong" || mode==="old") && !state.isLogged) { openAuth('login'); return; }
      state.pendingMode = mode;
      
      document.getElementById("settings-old-wrap").classList.toggle("hidden", mode!=="old");
      settingsError.style.display = "none";
      settingsModal.classList.add("active");
    }
    function closeSettings(){ settingsModal.classList.remove("active"); }
    function setQuickLimit(n){ settingsLimit.value = n; }
    function setOldDays(n){ document.getElementById("settings-old-days").value = n; }

    async function startFromSettings(){
      const mode = state.pendingMode;
      const limit = parseInt(settingsLimit.value) || 20;
      let qs = [];
      const courseId = state.currentCourseId;
      const map = QMAP[courseId];

      if (mode === "modules"){
         state.selectedModules.forEach(m => {
           if(QUIZ_PACKS[courseId].modules[m]) {
             QUIZ_PACKS[courseId].modules[m].forEach(q => qs.push(map[makeQid(courseId, m, q.q)]));
           }
         });
      }
      else if (mode === "course_exam"){
         qs = Object.values(map);
      }
      else if (mode === "search"){
         state.searchHits.forEach(qid => { if(map[qid]) qs.push(map[qid]); });
      }
      else if (mode === "wrong"){
        // FIX: Recupera ID errori dal DB e mappa su locale
        const { data } = await supa.from("question_progress")
          .select("qid").eq("user_id", state.currentUser.id).eq("course_id", courseId)
          .gt("wrong", 0).order("wrong", {ascending:false}).limit(300);
        
        if(data) data.forEach(r => { if(map[r.qid]) qs.push(map[r.qid]); });
      }
      else if (mode === "old"){
        // FIX: Calcolo giorni e gestione null
        const days = parseInt(document.getElementById("settings-old-days").value) || 14;
        const includeUnseen = document.getElementById("settings-old-unseen").checked;
        const cutoff = Date.now() - (days * 86400000);
        
        // Recupera tutte le domande viste
        const { data } = await supa.from("question_progress")
           .select("qid, last_seen").eq("user_id", state.currentUser.id).eq("course_id", courseId);
        
        const seenMap = new Map();
        if(data) data.forEach(r => seenMap.set(r.qid, r.last_seen ? new Date(r.last_seen).getTime() : 0));

        // Filtra
        Object.keys(map).forEach(qid => {
           const lastTime = seenMap.get(qid);
           // Se non √® mai stata vista: includi se includeUnseen √® true
           if (lastTime === undefined) {
             if(includeUnseen) qs.push(map[qid]);
           } else {
             // Se vista, controlla quanto tempo fa
             if (lastTime < cutoff) qs.push(map[qid]);
           }
        });
        // Ordina per pi√π vecchia
        qs.sort((a,b) => {
           const ta = seenMap.get(makeQid(courseId, a.module, a.q)) || 0;
           const tb = seenMap.get(makeQid(courseId, b.module, b.q)) || 0;
           return ta - tb;
        });
      }

      if (qs.length === 0) {
        settingsError.textContent = "Nessuna domanda trovata per i criteri selezionati.";
        settingsError.style.display = "block";
        return;
      }

      closeSettings();
      startQuiz(qs, limit);
    }

    /***********************************************************************
     * ENGINE QUIZ
     **********************************************************************/
    function startQuiz(qs, limit){
      let list = shuffle(qs);
      if(limit > 0) list = list.slice(0, limit);
      
      state.quizQuestions = list.map(x => ({
        ...x,
        qid: makeQid(state.currentCourseId, x.module, x.q),
        options: shuffle([...x.a]),
        correctIndex: 0 // placeholder, calcolato sotto
      }));

      // Ricalcola indici corretti dopo shuffle opzioni
      state.quizQuestions.forEach(q => {
         const correctTxt = q.a[0]; // La prima in array originale √® sempre corretta nel JSON
         q.correctIndex = q.options.indexOf(correctTxt);
      });

      state.quizIndex = 0; state.quizCorrect = 0; state.quizAnswered = false;
      
      crumbEl.textContent = `Quiz in corso`;
      navTo("quiz");
      renderQuestion();
    }

    function renderQuestion(){
      if(state.quizIndex >= state.quizQuestions.length) { finishQuiz(); return; }
      state.quizAnswered = false;
      const q = state.quizQuestions[state.quizIndex];
      
      qChip.textContent = q.module;
      qCounter.textContent = `${state.quizIndex+1} / ${state.quizQuestions.length}`;
      progressBar.style.width = ((state.quizIndex)/state.quizQuestions.length*100)+"%";
      qText.textContent = q.q;
      
      optionsContainer.innerHTML = "";
      q.options.forEach((txt, i) => {
        const btn = document.createElement("button");
        btn.className = "opt-btn";
        btn.textContent = txt;
        btn.onclick = () => handleAnswer(i, btn);
        optionsContainer.appendChild(btn);
      });
      
      btnNext.textContent = "Salta ‚Üí";
      btnNext.disabled = false;
    }

    function handleAnswer(idx, btn){
      if(state.quizAnswered) return;
      state.quizAnswered = true;
      const q = state.quizQuestions[state.quizIndex];
      const all = document.querySelectorAll(".opt-btn");
      
      const isCorrect = (idx === q.correctIndex);
      if(isCorrect) { btn.classList.add("correct"); state.quizCorrect++; }
      else { 
        btn.classList.add("wrong"); 
        if(all[q.correctIndex]) all[q.correctIndex].classList.add("correct"); 
      }
      
      btnNext.textContent = (state.quizIndex === state.quizQuestions.length-1) ? "Risultati" : "Prossima ‚Üí";
      
      // Save single attempt
      if(state.isLogged && supa){
        supa.rpc("record_question_attempt", {
          p_course_id: state.currentCourseId, p_qid: q.qid, p_module: q.module, p_cat: q.cat, p_is_correct: isCorrect
        }).catch(console.warn);
      }
    }

    function nextQuestion(){
      if(!state.quizAnswered && !confirm("Saltare la domanda?")) return;
      state.quizIndex++;
      renderQuestion();
    }

    function quitQuiz(){
      if(confirm("Uscire? Perderai i progressi attuali.")) backToCourse();
    }

    async function finishQuiz(){
      const pct = Math.round((state.quizCorrect/state.quizQuestions.length)*100);
      finalScore.textContent = pct + "%";
      finalMsg.textContent = pct > 60 ? "Ben fatto!" : "Ripassa ancora.";
      navTo("results");
      
      if(state.isLogged && supa){
         await supa.from("quiz_attempts").insert({
           user_id: state.currentUser.id,
           course_id: state.currentCourseId,
           total: state.quizQuestions.length,
           correct: state.quizCorrect,
           percent: pct,
           modules: [...state.selectedModules]
         });
         toast("success", "Salvato", "Statistiche aggiornate.");
      }
    }

    /***********************************************************************
     * AUTENTICAZIONE & RECUPERO PASSWORD
     **********************************************************************/
    function openAuth(mode){
      authError.style.display = "none";
      authLogin.classList.add("hidden");
      authSignup.classList.add("hidden");
      authReset.classList.add("hidden");
      authUpdate.classList.add("hidden");
      
      if(mode === 'login'){
        authTitle.textContent = "Accedi";
        authLogin.classList.remove("hidden");
      } else if(mode === 'signup'){
        authTitle.textContent = "Registrati";
        authSignup.classList.remove("hidden");
      } else if(mode === 'reset'){
        authTitle.textContent = "Recupero Password";
        authSub.textContent = "Ti invieremo un link via email.";
        authReset.classList.remove("hidden");
      } else if(mode === 'update'){
        authTitle.textContent = "Nuova Password";
        authSub.textContent = "Scegli una nuova password sicura.";
        authUpdate.classList.remove("hidden");
      }
      navTo("auth");
    }

    function navBackFromAuth(){
      // Se era in fase di recupero, torna al login, altrimenti dashboard
      if(!authUpdate.classList.contains("hidden")) openAuth('login');
      else navTo("dashboard");
    }

    // 1. Login
    async function login(){
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPass").value;
      const { error } = await supa.auth.signInWithPassword({ email, password: pass });
      if(error) showAuthError(error.message);
      else navTo("dashboard");
    }

    // 2. Signup
    async function signup(){
      const email = document.getElementById("signupEmail").value;
      const pass = document.getElementById("signupPass").value;
      const user = document.getElementById("signupUser").value;
      const { data, error } = await supa.auth.signUp({ 
        email, password: pass, 
        options: { data: { username: user } } 
      });
      if(error) showAuthError(error.message);
      else {
        alert("Controlla la tua email per confermare l'account!");
        openAuth('login');
      }
    }

    // 3. Request Password Reset
    async function requestPasswordReset(){
      const email = document.getElementById("resetEmail").value;
      const btn = document.getElementById("btn-reset-req");
      if(!email) { showAuthError("Inserisci email"); return; }
      
      btn.disabled = true; btn.textContent = "Invio...";
      
      const { error } = await supa.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.href // Torna qui
      });
      
      btn.disabled = false; btn.textContent = "Invia link";
      
      if(error) showAuthError(error.message);
      else {
        toast("success", "Email Inviata", "Controlla la posta per il link di reset.");
        openAuth('login');
      }
    }

    // 4. Update Password (dopo click sul link email)
    async function updateUserPassword(){
      const pass = document.getElementById("updatePass").value;
      if(!pass || pass.length < 6) { showAuthError("Password troppo corta"); return; }
      
      const { error } = await supa.auth.updateUser({ password: pass });
      if(error) showAuthError(error.message);
      else {
        toast("success", "Password Aggiornata", "Ora puoi accedere.");
        navTo("dashboard");
      }
    }

    async function logout(){
      await supa.auth.signOut();
      window.location.reload();
    }
    
    function switchAccount(){ logout(); }

    function showAuthError(msg){
      authError.textContent = msg;
      authError.style.display = "block";
    }

    function setAuthUI(user){
      state.isLogged = !!user;
      state.currentUser = user;
      if(user){
        chipAuth.textContent = "Utente";
        userDisplay.textContent = user.email;
        profileLoggedOut.classList.add("hidden");
        profileLoggedIn.classList.remove("hidden");
        document.getElementById("dash-loggedout").classList.add("hidden");
        document.getElementById("dash-loggedin").classList.remove("hidden");
      } else {
        chipAuth.textContent = "Ospite";
        profileLoggedOut.classList.remove("hidden");
        profileLoggedIn.classList.add("hidden");
        document.getElementById("dash-loggedout").classList.remove("hidden");
        document.getElementById("dash-loggedin").classList.add("hidden");
      }
    }

    async function initAuth(){
      // Check if this is a password recovery redirect
      // Supabase appende #access_token=...&type=recovery
      const hash = window.location.hash;
      if(hash && hash.includes("type=recovery")){
         // L'utente √® tecnicamente loggato ora.
         // Dobbiamo mostrare il form di cambio password.
         openAuth('update');
      }

      const { data } = await supa.auth.getSession();
      setAuthUI(data.session?.user);

      supa.auth.onAuthStateChange((event, session) => {
        if(event === 'PASSWORD_RECOVERY') {
           openAuth('update');
        } else {
           setAuthUI(session?.user);
        }
      });
    }

    function wireAuthEnterKeys(){
       document.getElementById("loginPass").addEventListener("keyup", e=>e.key==="Enter"&&login());
    }

    /***********************************************************************
     * UTILS / CHARTS
     **********************************************************************/
    function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a;}
    function trim(s,n){return s.length>n?s.slice(0,n)+"‚Ä¶":s;}
    function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}
    
    // Hash consistente per ID domande
    function makeQid(c,m,q){
      let h=0x811c9dc5; const s = (c+"||"+m+"||"+q).toLowerCase();
      for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,0x01000193);}
      return c+":"+(h>>>0).toString(16);
    }

    let progressType = "line";
    function setProgressType(t){
       progressType=t; 
       document.getElementById("btn-line").classList.toggle("active",t==="line");
       document.getElementById("btn-bar").classList.toggle("active",t==="bar");
       drawProgressChart(__progressPoints);
    }

    // Charting code semplificato per brevit√†
    function setupCanvas(id, hCSS){
      const c = document.getElementById(id);
      if(!c)return null;
      const dpr=window.devicePixelRatio||1;
      const rect=c.getBoundingClientRect();
      c.width=rect.width*dpr; c.height=hCSS*dpr;
      const ctx=c.getContext("2d");
      ctx.scale(dpr,dpr);
      return {ctx, w:rect.width, h:hCSS};
    }

    function drawProgressChart(data){
      const obj = setupCanvas("progressChart", 130);
      if(!obj) return;
      const {ctx, w, h} = obj;
      ctx.clearRect(0,0,w,h);
      
      if(!data.length) { 
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-sec');
        ctx.fillText("Nessun dato.", w/2-30, h/2); return; 
      }
      
      const pts = data.map(d=>d.percent);
      const step = w / (Math.max(pts.length, 2)-1);
      
      ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--primary');
      ctx.lineWidth = 2;
      ctx.beginPath();
      pts.forEach((p,i) => {
         const y = h - (p/100 * (h-20)) - 10;
         if(i===0) ctx.moveTo(0, y); else ctx.lineTo(i*step, y);
      });
      ctx.stroke();
    }

    function drawModuleChart(labels, vals){
       const obj = setupCanvas("moduleChart", 180);
       if(!obj)return;
       const {ctx, w, h} = obj;
       const barW = (w / labels.length) - 10;
       ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--primary');
       
       vals.forEach((v,i)=>{
          const bh = (v/100)*(h-20);
          ctx.fillRect(i*(barW+10)+5, h-bh, barW, bh);
       });
    }

    function queueChartRedraw(){
      drawProgressChart(__progressPoints);
    }
    function initChartObservers(){} // Placeholder
    function toast(type, title, msg){ alert(`${title}: ${msg}`); } // Semplificato

  </script>
</body>
</html>
